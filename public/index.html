<!DOCTYPE html> <!-- HTML belgesinin tipini tarayÄ±cÄ±ya bildirir -->
<html lang="tr"> <!-- SayfanÄ±n dilinin TÃ¼rkÃ§e olduÄŸunu belirtir -->
<head>
<meta charset="UTF-8"> <!-- TÃ¼rkÃ§e karakter desteÄŸi saÄŸlar -->
<meta name="viewport" content="width=device-width,initial-scale=1"/> <!-- Mobil uyumluluk iÃ§in Ã¶lÃ§ek ayarÄ± -->

<title>AkÄ±llÄ± DC GÃ¼Ã§ Ãœnitesi</title> <!-- TarayÄ±cÄ± sekmesinde gÃ¶rÃ¼nen baÅŸlÄ±k -->

<link rel="icon" type="image/png" href="https://upload.wikimedia.org/..."> <!-- Favicon (kÃ¼Ã§Ã¼k ikon) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Grafik Ã§izmek iÃ§in Chart.js kÃ¼tÃ¼phanesi -->

<style>
html, body {
  height: 100%; /* SayfanÄ±n tamamÄ±nÄ± kaplamasÄ±nÄ± saÄŸlar */
  background: var(--bg); /* Tema arka plan rengi */
  color: var(--text); /* Tema yazÄ± rengi */
}

html.dark, body.dark {
  background: var(--bg); /* KaranlÄ±k mod arka plan */
  color: var(--text); /* KaranlÄ±k modda yazÄ± rengi */
}

/* ------------------------
     TEMA DEÄÄ°ÅKENLERÄ°
--------------------------- */
body{
  font-family:'Segoe UI',Arial,sans-serif; /* Sayfa yazÄ± tipi */
  margin:0;padding:0; /* VarsayÄ±lan boÅŸluklarÄ± kaldÄ±rÄ±r */
  --bg:#eef2f6; /* AÃ§Ä±k mod arka plan */
  --text:#111; /* AÃ§Ä±k mod yazÄ± rengi */
  --card:rgba(255,255,255,0.6); /* Kart arka planÄ± */
  --border:rgba(255,255,255,0.5); /* Kart kenarlÄ±k rengi */
}
body.dark{
  --bg:#0b0c0e; /* KaranlÄ±k mod arka plan */
  --text:#eee; /* KaranlÄ±k mod yazÄ± rengi */
  --card:rgba(20,20,20,0.48); /* KaranlÄ±k mod kart */
  --border:rgba(255,255,255,0.06); /* KaranlÄ±k mod kenarlÄ±k */
}

/* ------------------------
     GÄ°RÄ°Å EKRANI
--------------------------- */
#loginScreen{
  position:fixed; inset:0; /* EkranÄ±n tamamÄ±nÄ± kaplar */
  background:var(--bg); /* Tema rengi */
  display:flex; flex-direction:column; /* Ä°Ã§erikleri dikey hizalar */
  align-items:center; justify-content:center; /* Ortalar */
  gap:18px; /* Elemanlar arasÄ± boÅŸluk */
}
#loginBox{
  background:var(--card); /* Kart arka plan rengi */
  border:1px solid var(--border); /* Kart kenarlÄ±ÄŸÄ± */
  padding:22px 28px; width:300px; /* Boyutlar */
  border-radius:14px; /* KÃ¶ÅŸeleri yumuÅŸatÄ±r */
  display:flex; flex-direction:column; gap:12px; /* Ä°Ã§ dÃ¼zen */
  text-align:center; /* YazÄ±yÄ± ortalar */
  transition:0.25s; /* Animasyon geÃ§iÅŸ sÃ¼resi */
}
#loginBox.shake{
  animation:shakeAnim 0.35s ease; /* YanlÄ±ÅŸ giriÅŸte sallanma animasyonu */
}
@keyframes shakeAnim{
  0%{transform:translateX(0);} /* Animasyon baÅŸlangÄ±cÄ± */
  25%{transform:translateX(-6px);} /* Sola kayma */
  50%{transform:translateX(6px);} /* SaÄŸa kayma */
  75%{transform:translateX(-6px);} /* Sola kayma */
  100%{transform:translateX(0);} /* Eski haline dÃ¶nme */
}
#loginBox.errorBorder{
  border:1px solid #c62828; /* Hata olunca kÄ±rmÄ±zÄ± Ã§erÃ§eve */
  box-shadow:0 0 8px rgba(198,40,40,0.6); /* Hata parlama efekti */
}
#loginBox.success{
  border:1px solid #00c853 !important; /* BaÅŸarÄ±lÄ± giriÅŸ yeÅŸil Ã§erÃ§eve */
  box-shadow:0 0 14px rgba(0,200,83,0.8) !important; /* YeÅŸil parÄ±ltÄ± */
  animation:successPop 0.45s ease forwards; /* "kÃ¼Ã§Ã¼lerek kaybolma" animasyonu */
}
@keyframes successPop{
  0%{ transform:scale(1); opacity:1; }
  50%{ transform:scale(1.07); opacity:1; }
  100%{ transform:scale(0.7); opacity:0; } /* Kutuyu gizler */
}

#loginBox input{
  padding:10px; border-radius:8px; /* KÃ¶ÅŸeleri yuvarlama */
  border:1px solid var(--border); width:100%; /* KenarlÄ±k ve geniÅŸlik */
}
#passwordWrap{ position:relative;width:100%; } /* GÃ¶z ikonuna alan aÃ§ar */
#togglePass{
  position:absolute;right:10px;top:50%; /* Åifre gÃ¶ster ikonunun konumu */
  transform:translateY(-50%);
  cursor:pointer;font-size:18px;
}
#capsWarning{
  color:#c62828;font-size:12px; /* Caps lock uyarÄ± yazÄ±sÄ± */
  display:none;margin-top:-6px;
}
#loginBox button{
  padding:10px;border-radius:8px;border:none;
  cursor:pointer;background:#1E88E5;color:white; /* GiriÅŸ butonu rengi */
  font-size:15px;font-weight:600;
}
#blockMsg{color:#c62828;font-size:13px;} /* Bloke mesajÄ± */

/* ------------------------
    Ã‡IKIÅ BUTONU
--------------------------- */
.logoutBtn{
  cursor:pointer;font-size:15px;
  padding:6px 10px;border-radius:8px; /* Buton ÅŸekli */
  border:1px solid var(--border);background:var(--card); /* Tema uyumlu */
}

/* ------------------------
   DASHBOARD ALANI
--------------------------- */
.header{
  display:flex;justify-content:space-between; /* Sol / saÄŸ bÃ¶lÃ¼mleri ayÄ±rÄ±r */
  align-items:center;
  max-width:1200px;margin:0 auto 12px;padding:14px;
}
.title{display:flex;flex-direction:column;font-weight:700;} /* BaÅŸlÄ±k alanÄ± */
.subtitle{font-size:12px;opacity:0.75;margin-top:4px;} /* Alt aÃ§Ä±klama */
.right-controls{display:flex;align-items:center;gap:12px;} /* SaÄŸ Ã¼stteki iÅŸlev tuÅŸlarÄ± */
.clock{
  font-size:16px;font-weight:600;padding:8px 12px;border-radius:10px;
  background:var(--card);border:1px solid var(--border); /* CanlÄ± saat */
}
.lastData{font-size:12px;opacity:0.85;margin-top:6px;} /* Son veri zamnaÄ± metni */
.themeToggle{
  padding:6px 10px;border-radius:6px;
  border:1px solid var(--border);background:var(--card);
  cursor:pointer;font-size:14px; /* Tema deÄŸiÅŸtir butonu */
}

.summary{
  max-width:1200px;margin:8px auto;
  display:flex;gap:12px;justify-content:center;
  flex-wrap:wrap;padding:0 14px; /* Toplam deÄŸer kutularÄ± */
}
.sum-card{
  background:var(--card);border:1px solid var(--border);
  padding:12px 16px;border-radius:12px; /* Kart gÃ¶rÃ¼nÃ¼mÃ¼ */
  min-width:120px;text-align:center;
}

.grid{
  max-width:1200px;margin:14px auto;
  display:grid;grid-template-columns:repeat(2,1fr); /* 2 kolonlu kart dÃ¼zeni */
  gap:16px;padding:0 14px;
}
@media(max-width:800px){ .grid{grid-template-columns:1fr;} } /* Telefon iÃ§in tek kolon */

.card{
  background:var(--card);border:1px solid var(--border);
  border-radius:14px;padding:12px;
  box-shadow:0 6px 18px rgba(0,0,0,0.06); /* Hafif gÃ¶lge efekti */
  transform-origin:top;transform:scale(0.9); /* Hover animasyon baÅŸlangÄ±cÄ± */
}
.card:hover{transform:scale(0.94);} /* Kart bÃ¼yÃ¼r */
.card-title{
  display:flex;justify-content:space-between;align-items:center;
  gap:8px;margin-bottom:8px;font-weight:700;font-size:15px; /* Kart baÅŸlÄ±ÄŸÄ± */
}
.status-dot{
  width:12px;height:12px;border-radius:50%; /* KÃ¼Ã§Ã¼k renkli durum Ä±ÅŸÄ±ÄŸÄ± */
  display:inline-block;margin-left:8px;
}
.values-row{
  display:flex;justify-content:space-between;gap:10px;margin-bottom:8px; /* Volt/AkÄ±m/GÃ¼Ã§ kutularÄ± */
}
.val-box{text-align:center;flex:1;}
.val-num{
  font-weight:800;font-size:16px;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.tiny{font-size:12px;opacity:0.7;} /* KÃ¼Ã§Ã¼k yazÄ±lar */

/* -------------------------
   OTURUM UYARISI MODALI
---------------------------- */
#sessionModal {
  position: fixed; inset: 0; /* TÃ¼m ekran */
  backdrop-filter: blur(4px); /* Arka planÄ± blur yapar */
  background: rgba(0,0,0,0.55); /* KaranlÄ±k ÅŸeffaf katman */
  display: none; /* VarsayÄ±lan gizli */
  align-items: center;justify-content: center;
  z-index: 9999; /* En Ã¶nde gÃ¶rÃ¼nmesi iÃ§in */
}

#sessionModalBox {
  background: var(--card); /* Modal kutusunun arka planÄ± */
  border: 1px solid var(--border); /* KenarlÄ±k */
  padding: 24px; /* Ä°Ã§ boÅŸluk */
  border-radius: 12px; /* KÃ¶ÅŸeleri yuvarlat */
  width: 320px; /* GeniÅŸlik */
  text-align: center; /* OrtalÄ± iÃ§erik */
  animation: popIn .25s ease; /* AÃ§Ä±lma animasyonu */
}
@keyframes popIn {
  0%{ transform: scale(0.7); opacity: 0; } /* KÃ¼Ã§Ã¼k ve gÃ¶rÃ¼nmez baÅŸlar */
  100%{ transform: scale(1); opacity: 1; } /* Normal boyutta gÃ¶rÃ¼nÃ¼r hale gelir */
}
#sessionModal button {
  margin-top: 12px; /* Ãœstten boÅŸluk */
  width: 100%; /* Tam geniÅŸlik */
  padding: 10px; /* Ä°Ã§ boÅŸluk */
  border-radius: 8px; /* Yuvarlak buton */
  border: none; /* KenarlÄ±k yok */
  cursor: pointer; /* TÄ±klanabilir iÅŸaret */
  font-weight: 600; /* KalÄ±n yazÄ± */
}
#continueBtn { background:#1E88E5;color:white; } /* Devam et butonu */
#logoutBtn2 { background:#b71c1c;color:white;margin-top:10px; } /* Ã‡Ä±kÄ±ÅŸ yap butonu */

/* ---------------------------------------------
   ğŸ”Œ BAÄLI CÄ°HAZLAR MODALÄ°
---------------------------------------------- */
#devicesModal {
  position: fixed; inset: 0; /* TÃ¼m ekranÄ± kaplar */
  backdrop-filter: blur(4px); /* Arka plan bulanÄ±k */
  background: rgba(0,0,0,0.55); /* Koyu ÅŸeffaf arkaplan */
  display: none; /* BaÅŸta kapalÄ± */
  align-items: center; justify-content: center; /* Ortala */
  z-index: 9999; /* Ãœstte gÃ¶rÃ¼nmesi iÃ§in */
}
#devicesModalBox {
  background: var(--card); /* Kart gÃ¶rÃ¼nÃ¼mÃ¼ */
  border: 1px solid var(--border); /* KenarlÄ±k */
  padding: 20px; /* Ä°Ã§ boÅŸluk */
  border-radius: 12px; /* KÃ¶ÅŸe yumuÅŸatma */
  width: 360px; /* Modal geniÅŸliÄŸi */
  max-width: 95vw; /* Mobilde taÅŸmamasÄ± iÃ§in */
  text-align: left; /* Soldan hizalÄ± iÃ§erik */
  animation: popIn .25s ease; /* AÃ§Ä±lma animasyonu */
}
#devicesList {
  max-height: 260px; /* Liste uzunluÄŸu */
  overflow-y: auto; /* AÅŸÄ±nca kaydÄ±rma */
  margin-top: 8px;
}
.deviceRow {
  border-bottom: 1px solid var(--border); /* Her cihaz satÄ±rÄ± ayrÄ±m Ã§izgisi */
  padding: 6px 0 10px 0;
}
.deviceRow:last-child {
  border-bottom: none; /* Son satÄ±r Ã§izgisiz */
}
.deviceRow button {
  margin-top: 6px;
  padding: 6px 10px;
  border-radius: 6px; /* Yuvarlak buton */
  border: none;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  background:#b71c1c; /* KÄ±rmÄ±zÄ± Ã§Ä±kÄ±ÅŸ butonu */
  color:white;
}
#closeDevicesBtn {
  margin-top: 12px;
  width: 100%; /* Tam geniÅŸlik */
  padding: 8px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 600;
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen"> <!-- KullanÄ±cÄ± adÄ±/ÅŸifre ekranÄ± -->
  <img src="https://upload.wikimedia.org/...svg.png"
       style="width:110px;margin-bottom:10px;"> <!-- Logo -->

  <div id="loginBox"> <!-- Login kutusu -->
    <h3>GiriÅŸ Yap</h3>

    <input id="username" placeholder="KullanÄ±cÄ± adÄ±"> <!-- KullanÄ±cÄ± adÄ± alanÄ± -->

    <div id="passwordWrap"> <!-- Åifre alanÄ±nÄ± ve gÃ¶z ikonunu sarar -->
      <input id="password" type="password" placeholder="Åifre"> <!-- Åifre inputu -->
      <span id="togglePass">ğŸ‘ï¸</span> <!-- Åifreyi gÃ¶ster/gizle butonu -->
    </div>

    <div id="capsWarning">Caps Lock aÃ§Ä±k!</div> <!-- Caps Lock uyarÄ±sÄ± -->

    <button onclick="handleLogin()">GiriÅŸ</button> <!-- Login butonu -->

    <div id="loginError" style="color:#c62828;font-size:13px;"></div> <!-- Hata mesajÄ± -->
    <div id="blockMsg"></div> <!-- Bloke mesajÄ± -->
  </div>
</div>

<!-- SESSION MODAL -->
<div id="sessionModal"> <!-- Oturum sÃ¼resi bitmek Ã¼zere uyarÄ±sÄ± -->
  <div id="sessionModalBox">
    <h3>Oturum SÃ¼reniz Dolmak Ãœzere</h3>
    <p>YaklaÅŸÄ±k <span id="remainingText">10</span> dakika iÃ§inde otomatik Ã§Ä±kÄ±ÅŸ yapÄ±lacak.</p>
    <button id="continueBtn">Devam Et</button>
    <button id="logoutBtn2">Ã‡Ä±kÄ±ÅŸ Yap</button>
  </div>
</div>

<!-- CÄ°HAZ LÄ°STESÄ° MODAL -->
<div id="devicesModal"> <!-- BaÄŸlÄ± cihazlar ekranÄ± -->
  <div id="devicesModalBox">
    <h3>ğŸ”Œ BaÄŸlÄ± Cihazlar</h3>
    <div id="devicesList" class="tiny"></div> <!-- Cihaz listesi -->
    <button id="closeDevicesBtn">Kapat</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" style="display:none;"> <!-- GiriÅŸ sonrasÄ± aÃ§Ä±lan panel -->

  <div class="header"> <!-- Ãœst bar -->
    <div class="title">
      <div>AkÄ±llÄ± DC GÃ¼Ã§ Ãœnitesi</div> <!-- Ãœst baÅŸlÄ±k -->
      <div class="subtitle" id="globalStatusText">BaÄŸlantÄ± kontrol ediliyor...</div> <!-- Sistem durumu -->
    </div>

    <div class="right-controls"> <!-- SaÄŸ Ã¼st kontrol butonlarÄ± -->
      <div class="clock" id="realtimeClock">--:--:--</div> <!-- CanlÄ± saat -->
      <button class="themeToggle" id="themeToggle">ğŸŒ™</button> <!-- Tema butonu -->
      <button class="themeToggle" id="devicesBtn">ğŸ”Œ BaÄŸlÄ± Cihazlar</button> <!-- Cihaz listesi -->
      <button class="logoutBtn" onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button> <!-- Ã‡Ä±kÄ±ÅŸ -->
      <div class="lastData tiny" id="lastDataTs">Son veri: â€”</div> <!-- Son veri zamanÄ± -->
    </div>
  </div>

  <div class="summary"> <!-- Ãœstteki toplam deÄŸer kartlarÄ± -->
    <div class="sum-card"><div class="sum-label">Toplam Voltaj</div><div class="sum-val" id="sumV">0.0 V</div></div>
    <div class="sum-card"><div class="sum-label">Toplam AkÄ±m</div><div class="sum-val" id="sumA">0.00 A</div></div>
    <div class="sum-card"><div class="sum-label">Toplam GÃ¼Ã§</div><div class="sum-val" id="sumW">0.0 W</div></div>
  </div>

  <div class="grid" id="grid"></div> <!-- SensÃ¶r kartlarÄ± buraya oluÅŸturulacak -->
</div>

<script>
/* ============================================================
   LOGIN + TOKEN SÄ°STEMÄ°
============================================================ */
const loginBox = document.getElementById("loginBox"); /* Login kutusunu seÃ§er */

function saveToken(t){ localStorage.setItem("sessionToken", t); } /* Oturum token kaydetme */
function loadToken(){ return localStorage.getItem("sessionToken"); } /* Tokeni okur */
function clearToken(){ localStorage.removeItem("sessionToken"); } /* Tokeni siler */

/* ENTER tuÅŸu ile giriÅŸ */
loginBox.addEventListener("keydown", e=>{
  if(e.key==="Enter") handleLogin(); /* Enter'a basÄ±nca giriÅŸ yapÄ±lÄ±r */
});

/* CAPS LOCK uyarÄ±sÄ± */
document.getElementById("password").addEventListener("keyup", e=>{
  document.getElementById("capsWarning").style.display =
    e.getModifierState("CapsLock") ? "block" : "none"; /* Caps Lock aÃ§Ä±k mÄ±? */
});

/* Åifre gÃ¶ster/gizle */
document.getElementById("togglePass").onclick = ()=>{
  const p=document.getElementById("password");
  p.type = p.type==="password" ? "text" : "password"; /* Åifre gÃ¶rÃ¼nÃ¼r/gizli */
};

/* LOGIN Ä°ÅLEMÄ° */
async function handleLogin(){
  loginBox.classList.remove("errorBorder","shake","success"); /* Eski efektleri kaldÄ±r */

  const username=document.getElementById("username").value.trim(); /* KullanÄ±cÄ± adÄ± */
  const password=document.getElementById("password").value; /* Åifre */

  const res=await fetch("/api/login",{ /* sunucuya login isteÄŸi */
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ username,password })
  });

  const data=await res.json(); /* Sunucu cevabÄ± */

  if(data.ok){
    loginBox.classList.add("success"); /* BaÅŸarÄ±lÄ± efekt */
    setTimeout(()=>{
      saveToken(data.token); /* Tokeni kaydet */
      showDashboard(); /* Dashboard'a geÃ§iÅŸ */
    },450);
    return;
  }

  loginBox.classList.add("errorBorder","shake"); /* HatalÄ± giriÅŸ efekti */

  if(data.error==="wrong"){
    document.getElementById("loginError").innerText="HatalÄ± kullanÄ±cÄ± adÄ± veya ÅŸifre!"; /* YanlÄ±ÅŸ giriÅŸ */
  }
  else if(data.error==="blocked"){
    document.getElementById("blockMsg").innerText=`${data.remain} saniye sonra tekrar deneyin.`; /* GeÃ§ici blok */
  }
  else if(data.error==="blocked30"){
    document.getElementById("blockMsg").innerText="3 hatalÄ± giriÅŸ! 30 saniye bloke edildi."; /* 3 yanlÄ±ÅŸ deneme */
  }
}

/* TOKEN KONTROLÃœ (Sayfa aÃ§Ä±lÄ±nca oturum geÃ§erli mi?) */
async function checkToken(){
  const token=loadToken(); /* KayÄ±tlÄ± token'i oku */
  if(!token) return false; /* Token yoksa giriÅŸ yapÄ±lmamÄ±ÅŸ demektir */

  const res=await fetch("/api/check-token",{ headers:{ "authorization":token } }); /* Token doÄŸrulama isteÄŸi */
  const data=await res.json();
  return data.ok===true; /* Token geÃ§erliyse true dÃ¶ner */
}

/* LOGOUT (Ã‡Ä±kÄ±ÅŸ iÅŸlemi) */
let sessionTimer = null; /* Oturum zamanlayÄ±cÄ±sÄ±nÄ± tutar */
async function logout(){
  const token = loadToken();
  if(token){
    await fetch("/api/logout",{ /* Sunucuya Ã§Ä±kÄ±ÅŸ isteÄŸi gÃ¶nderir */
      method:"POST",
      headers:{ "authorization":token }
    });
  }

  clearToken(); /* TarayÄ±cÄ±daki tokenâ€™i sil */
  if(sessionTimer) { clearInterval(sessionTimer); sessionTimer=null; } /* SayaÃ§ varsa durdur */

  /* LOGIN BOXâ€™u sÄ±fÄ±rla (gÃ¼zel bir reset gÃ¶rÃ¼ntÃ¼sÃ¼) */
  loginBox.classList.remove("success", "errorBorder", "shake"); 
  loginBox.style.opacity = "1"; 
  loginBox.style.transform = "scale(1)";

  /* Input kutularÄ±nÄ± temizle */
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  document.getElementById("loginError").innerText = "";
  document.getElementById("blockMsg").innerText = "";

  /* Dashboardâ€™Ä± gizle, login ekranÄ±nÄ± aÃ§ */
  document.getElementById("dashboard").style.display="none";
  document.getElementById("loginScreen").style.display="flex";

  alert("GÃ¼Ã§ Ã¼nitesinden ayrÄ±lÄ±nÄ±yor..."); /* KullanÄ±cÄ±ya mesaj */
}

/* DASHBOARD AÃ‡ (GiriÅŸ baÅŸarÄ±lÄ± olduÄŸunda Ã§aÄŸrÄ±lÄ±r) */
function showDashboard(){
  document.getElementById("loginScreen").style.display="none"; /* Login ekranÄ±nÄ± kapat */
  document.getElementById("dashboard").style.display="block"; /* Dashboard'Ä± aÃ§ */
  startSessionWatcher(); /* Oturum sÃ¼resi takibini baÅŸlat */
}

/* SAYFA AÃ‡ILDIÄINDA OTOMATÄ°K GÄ°RÄ°Å KONTROLÃœ */
window.addEventListener("load", async()=>{
  if(await checkToken()) showDashboard(); /* Token geÃ§erliyse direkt Dashboard'a geÃ§ir */
});

/* ============================================================
   OTURUM SÃœRESÄ° TAKÄ°BÄ° (1 saat + bitmeye 10 dk kala uyarÄ±)
============================================================ */
let remainingMs = 0; /* Kalan sÃ¼re (ms) */
let modalShown = false; /* UyarÄ± gÃ¶sterildi mi? */

async function getSessionInfo(){
  const token = loadToken();
  if(!token) return;

  const res = await fetch("/api/session-info", {
    headers:{ authorization: token }
  });

  const data = await res.json();

  if(!data.ok){
    alert("Oturum sÃ¼resi doldu."); 
    logout(); /* Oturum bitmiÅŸse Ã§Ä±kÄ±ÅŸ yap */
    return;
  }

  remainingMs = data.remainMs; /* Sunucudan gelen kalan sÃ¼re */

  /* Bitmeye 10 dakika kala uyarÄ± aÃ§ */
  if(remainingMs <= 10*60*1000 && remainingMs > 0 && !modalShown){
    modalShown = true;
    const mins = Math.max(1, Math.ceil(remainingMs/60000)); /* Dakikaya Ã§evir */
    document.getElementById("remainingText").innerText = mins;
    document.getElementById("sessionModal").style.display = "flex"; /* UyarÄ± aÃ§Ä±lÄ±r */
  }

  /* SÃ¼re bittiyse direkt Ã§Ä±kÄ±ÅŸ */
  if(remainingMs <= 0){
    alert("Oturum sÃ¼resi doldu.");
    logout();
  }
}

function startSessionWatcher(){
  if(sessionTimer) clearInterval(sessionTimer);
  sessionTimer = setInterval(getSessionInfo, 5000); /* Her 5 saniyede kontrol et */
}

/* â€œDevam Etâ€ butonu â€“ oturumu uzatÄ±r */
document.getElementById("continueBtn").onclick = async ()=>{
  const token = loadToken();
  if(!token) return;

  const res = await fetch("/api/extend-session", {
    method:"POST",
    headers:{ authorization: token }
  });
  const data = await res.json();

  if(data.ok){
    modalShown = false;
    document.getElementById("sessionModal").style.display="none"; /* UyarÄ±yÄ± kapat */
    await getSessionInfo(); /* Yeni sÃ¼reyi tekrar al */
  }
};

/* â€œÃ‡Ä±kÄ±ÅŸ Yapâ€ butonu */
document.getElementById("logoutBtn2").onclick = ()=> logout();

/* ============================================================
   ğŸ”Œ BAÄLI CÄ°HAZLAR MODALÄ°
============================================================ */
document.getElementById("devicesBtn").onclick = openDevicesModal; /* Buton tÄ±klanÄ±nca modal aÃ§ */
document.getElementById("closeDevicesBtn").onclick = () => {
  document.getElementById("devicesModal").style.display = "none"; /* ModalÄ± kapat */
};

function formatMins(ms){
  return Math.max(0, Math.round(ms/60000)); /* ms â†’ dakika Ã§eviri */
}

async function openDevicesModal(){
  const token = loadToken();
  if(!token){
    alert("Ã–nce giriÅŸ yapmalÄ±sÄ±nÄ±z.");
    return;
  }

  const res = await fetch("/api/active-sessions", {
    headers:{ authorization: token }
  });
  const data = await res.json();

  if(!data.ok){
    alert("Oturum doÄŸrulanamadÄ±.");
    return;
  }

  const list = data.sessions || []; /* Aktif oturum listesi */
  const container = document.getElementById("devicesList");
  container.innerHTML = ""; /* Temizle */

  if(list.length === 0){
    container.innerHTML = "<div class='tiny'>Aktif oturum bulunamadÄ±.</div>";
  } else {
    list.forEach((s, idx)=>{
      const div = document.createElement("div");
      div.className = "deviceRow";

      const createdStr = new Date(s.createdAt).toLocaleString(); /* GiriÅŸ zamanÄ± */
      const mins = formatMins(s.remainMs); /* Kalan sÃ¼re dakika */
      const ua = (s.userAgent || "Bilinmeyen cihaz"); /* TarayÄ±cÄ± bilgisi */
      const shortUa = ua.length > 60 ? ua.slice(0,57) + "..." : ua; /* Ã‡ok uzunsa kÄ±salt */

      /* Cihaz kartÄ± HTML */
      div.innerHTML = `
        <div class="tiny"><strong>${idx+1}.</strong> ${shortUa}</div>
        <div class="tiny">IP: ${s.ip || "-"} | GiriÅŸ: ${createdStr}</div>
        <div class="tiny">Kalan sÃ¼re: ~${mins} dk</div>
        <button class="deviceLogoutBtn" data-token="${s.token}">Oturumu SonlandÄ±r</button>
      `;
      container.appendChild(div);
    });
  }

  document.getElementById("devicesModal").style.display = "flex"; /* ModalÄ± aÃ§ */

  /* Her butona tÄ±klanÄ±nca oturumu sonlandÄ±r */
  document.querySelectorAll(".deviceLogoutBtn").forEach(btn=>{
    btn.onclick = async ()=>{
      const targetToken = btn.getAttribute("data-token"); /* Hedef oturum tokeni */
      const myToken = loadToken(); /* Bu tarayÄ±cÄ±daki token */

      await fetch("/api/logout-token",{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          authorization: myToken
        },
        body: JSON.stringify({ token: targetToken })
      });

      if(targetToken === myToken){
        document.getElementById("devicesModal").style.display="none";
        logout(); /* EÄŸer bu cihazÄ±n oturumu kapandÄ±ysa logout */
      } else {
        openDevicesModal(); /* Listeyi yenile */
      }
    };
  });
}

/* ============================================================
   DASHBOARD KODU (SensÃ¶r verilerini iÅŸleme)
============================================================ */

const MON_NAMES=[
  "DC Soket Ã‡Ä±kÄ±ÅŸÄ± 1",
  "DC Soket Ã‡Ä±kÄ±ÅŸÄ± 2",
  "USB-A Portu 1",
  "USB-A Portu 2"
]; /* Her karta verilecek isimler */

const OFFLINE_THRESHOLD=10000; /* 10 saniye veri gelmezse â€œofflineâ€ kabul et */

let grid=document.getElementById("grid"); /* KartlarÄ±n yerleÅŸtirileceÄŸi alan */
let charts=[],lastReceived=[],lastGlobal=Date.now(); /* Grafik ve zaman takip deÄŸiÅŸkenleri */

/* CANLI SAAT */
setInterval(()=>{
  document.getElementById("realtimeClock").innerText=
    new Date().toLocaleTimeString(); /* Her saniye saati gÃ¼ncelle */
},1000);

/* TEMA DEÄÄ°ÅTÄ°RME BUTONU */
document.getElementById("themeToggle").onclick=()=>{
  document.body.classList.toggle("dark"); /* GÃ¶vdeyi karanlÄ±k/aÃ§Ä±k moda al */
  document.documentElement.classList.toggle("dark"); /* HTML etiketine de uygula */
  document.getElementById("themeToggle").innerText =
    document.body.classList.contains("dark") ? "â˜€ï¸" : "ğŸŒ™"; /* Ä°konu deÄŸiÅŸtir */
};

/* KARTLARIN OLUÅTURULMASI */
for(let i=0;i<MON_NAMES.length;i++){
  const id="mon"+i;

  /* Her kartÄ±n HTML yapÄ±sÄ± */
  const html=`
    <div class="card" id="${id}">
      <div class="card-title">
        <strong>${MON_NAMES[i]}</strong> <!-- Kart baÅŸlÄ±ÄŸÄ± -->
        <div id="dot${i}" class="status-dot" style="background:#f44;"></div> <!-- Durum Ä±ÅŸÄ±ÄŸÄ± -->
      </div>

      <div class="values-row">
        <div class="val-box">
          <div class="val-num"><span>ğŸ”‹</span><span id="v${i}">--</span></div>
          <div class="val-label">Volt (V)</div>
        </div>
        <div class="val-box">
          <div class="val-num"><span>ğŸ§²</span><span id="a${i}">--</span></div>
          <div class="val-label">AkÄ±m (A)</div>
        </div>
        <div class="val-box">
          <div class="val-num"><span>âš¡</span><span id="w${i}">--</span></div>
          <div class="val-label">GÃ¼Ã§ (W)</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div class="tiny">SÄ±caklÄ±k: <span id="t${i}">--</span>Â°C</div> <!-- SÄ±caklÄ±k -->
        <div class="tiny" id="stat${i}">Durum: â€”</div> <!-- Durum mesajÄ± -->
      </div>

      <canvas id="chart${i}" height="110"></canvas> <!-- Grafik alanÄ± -->
    </div>
  `;

  const div=document.createElement("div");
  div.innerHTML=html;
  grid.appendChild(div.firstElementChild); /* KartÄ± sayfaya ekle */

  lastReceived[i]=0; /* Bu kart iÃ§in son veri zamanÄ±nÄ± tut */
}

/* GRAFÄ°K OLUÅTURMA */
for(let i=0;i<MON_NAMES.length;i++){
  charts[i]=new Chart(document.getElementById("chart"+i).getContext("2d"),{
    type:"line", /* Ã‡izgi grafik */
    data:{
      labels:[], /* Zaman ekseni (gizli olacak) */
      datasets:[
        {label:"Volt (V)",data:[],borderColor:"#1E90FF",backgroundColor:"rgba(30,144,255,0.06)",pointRadius:0,tension:0.25},
        {label:"AkÄ±m (A)",data:[],borderColor:"#FF3B30",backgroundColor:"rgba(255,59,48,0.06)",pointRadius:0,tension:0.25},
        {label:"GÃ¼Ã§ (W)",data:[],borderColor:"#00C853",backgroundColor:"rgba(0,200,83,0.06)",pointRadius:0,tension:0.25}
      ]
    },
    options:{
      animation:false, /* Grafik animasyonu kapalÄ± (daha akÄ±cÄ± veri) */
      plugins:{ legend:{display:true} }, /* Ãœstte Volt/AkÄ±m/GÃ¼Ã§ baÅŸlÄ±klarÄ± */
      scales:{ x:{display:false} } /* X eksenini gizle */
    }
  });
}

/* DEÄERLER GÃœNCELLENÄ°NCE FLASH EFEKTÄ° */
function flash(el,type){
  el.classList.remove("flash-up","flash-down"); /* Ã–nce eski efekti kaldÄ±r */
  void el.offsetWidth; /* CSS reset hilesi */
  el.classList.add(type==="up"?"flash-up":"flash-down"); /* Efekti ekle */
  setTimeout(()=>el.classList.remove("flash-up","flash-down"),400); /* 400ms sonra sil */
}

/* ============================================================
   WEBSOCKET BAÄLANTISI (CANLI VERÄ°)
============================================================ */

const protocol=(location.protocol==="https:")?"wss:":"ws:"; /* HTTPSâ†’WSS otomatik */
const WS_URL=protocol+"//"+location.host; /* WebSocket adresi */
const socket=new WebSocket(WS_URL); /* BaÄŸlantÄ±yÄ± aÃ§ */

let lastTs=0; /* Son veri zaman damgasÄ± */

/* Gelen veriyi iÅŸleme */
socket.addEventListener("message",(e)=>{
  const msg=JSON.parse(e.data); /* Sunucudan gelen JSON */

  if(msg.type==="init" || msg.type==="update"){
    lastTs=msg.ts; /* Zaman damgasÄ±nÄ± al */
    document.getElementById("lastDataTs").innerText="Son veri: "+fmtTs(lastTs); /* GÃ¶ster */
    processData(msg.data||{}); /* Veriyi iÅŸle */
  }
  else if(msg.type==="offline"){
    makeAllOffline(); /* Sunucu baÄŸlantÄ±sÄ± koparsa tÃ¼m kartlarÄ± offline yap */
  }
});

/* Tarih formatÄ± */
function fmtTs(ts){
  if(!ts) return "â€”";
  const d=new Date(ts);
  return d.toLocaleDateString()+" "+d.toLocaleTimeString(); /* GÃ¼n + saat formatÄ± */
}

/* ============================================================
   VERÄ° Ä°ÅLEME FONKSÄ°YONU (KARTLARI GÃœNCELLER)
============================================================ */

function processData(obj){
  let totalV=0,totalA=0,totalW=0; /* Toplam deÄŸerler */
  let anyActive=false; /* Herhangi bir Ã§Ä±kÄ±ÅŸ aktif mi? */

  for(let i=0;i<MON_NAMES.length;i++){
    const d=obj["monitor"+(i+1)]?.hat1; /* monitor1.hat1 -> sensÃ¶r verisi */

    const vEl=document.getElementById("v"+i);
    const aEl=document.getElementById("a"+i);
    const wEl=document.getElementById("w"+i);
    const tEl=document.getElementById("t"+i);
    const statEl=document.getElementById("stat"+i);
    const dotEl=document.getElementById("dot"+i);
    const ch=charts[i];

    if(!d){
      vEl.innerText=aEl.innerText=wEl.innerText=tEl.innerText="-"; /* Veri yok */
      statEl.innerText="BaÄŸlantÄ± yok â€” kontrol edilmeli";
      dotEl.style.background="red"; /* Durum kÄ±rmÄ±zÄ± */
      continue; /* Bu kartÄ± atla */
    }

    const v=d.voltage.value;
    const a=d.current.value;
    const w=d.power.value;

    /* Verileri yaz */
    vEl.innerText=v.toFixed(2);
    aEl.innerText=a.toFixed(3);
    wEl.innerText=w.toFixed(2);
    tEl.innerText=d.temperature.value.toFixed(1);

    /* KÃ¼Ã§Ã¼k animasyon */
    flash(vEl,"up");
    flash(aEl,"up");
    flash(wEl,"up");

    /* Enerji Ã§ok dÃ¼ÅŸÃ¼kse uyarÄ± */
    if(a<0.005 || w<0.05){
      statEl.innerText="Enerji yok âš ï¸";
      dotEl.style.background="#ff9800"; /* Turuncu */
    } else {
      statEl.innerText="BaÄŸlantÄ±: Aktif";
      dotEl.style.background="#0f0"; /* YeÅŸil */
      anyActive=true;
    }

    /* Grafik ekleme */
    if(ch.data.labels.length>=30){
      ch.data.labels.shift(); /* En eskiyi sil */
      ch.data.datasets.forEach(ds=>ds.data.shift()); /* TÃ¼m grafik serilerinden sil */
    }

    ch.data.labels.push(""); /* Yeni zaman noktasÄ± */
    ch.data.datasets[0].data.push(v);
    ch.data.datasets[1].data.push(a);
    ch.data.datasets[2].data.push(w);
    ch.update("none"); /* Grafik animasyonsuz gÃ¼ncelle */

    /* ToplamlarÄ± hesapla */
    totalV+=v;
    totalA+=a;
    totalW+=w;
  }

  /* Toplam deÄŸerleri yaz */
  document.getElementById("sumV").innerText=totalV.toFixed(2)+" V";
  document.getElementById("sumA").innerText=totalA.toFixed(3)+" A";
  document.getElementById("sumW").innerText=totalW.toFixed(2)+" W";

  const globalEl=document.getElementById("globalStatusText");

  /* Genel sistem durumu */
  if(anyActive) globalEl.innerText="BaÄŸlantÄ± baÅŸarÄ±lÄ±";
  else if(Date.now()-lastTs>OFFLINE_THRESHOLD) globalEl.innerText="Sistem ile iletiÅŸim yok";
  else globalEl.innerText="BaÄŸlantÄ± kontrol ediliyor...";
}

/* ============================================================
   TÃœM KARTLARI OFFLINE YAP (WebSocket baÄŸlantÄ±sÄ± koptuÄŸunda)
============================================================ */

function makeAllOffline(){
  MON_NAMES.forEach((m,i)=>{
    document.getElementById("v"+i).innerText="-";
    document.getElementById("a"+i).innerText="-";
    document.getElementById("w"+i).innerText="-";
    document.getElementById("t"+i).innerText="-";
    document.getElementById("stat"+i).innerText="Sistem ile iletiÅŸim yok";
    document.getElementById("dot"+i).style.background="red"; /* KÄ±rmÄ±zÄ± Ä±ÅŸÄ±k */
  });

  document.getElementById("globalStatusText").innerText="Sistem ile iletiÅŸim yok"; /* Genel uyarÄ± */
}
</script>

</body>
</html>
