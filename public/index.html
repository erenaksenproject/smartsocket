<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>AkÄ±llÄ± DC GÃ¼Ã§ Ãœnitesi</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin:0; padding:0; }
  header { padding: 12px 0; display:flex; justify-content:center; align-items:center; gap:10px; background:#1f1f1f; font-size:26px; font-weight:bold; box-shadow:0 2px 6px rgba(0,0,0,0.5);}
  #clock { font-size:18px; color:#cfcfcf; }
  #connection { width:14px; height:14px; border-radius:50%; background:red; display:inline-block; vertical-align:middle; }
  #toggleRelay { margin-left:20px; padding:6px 12px; cursor:pointer; }

  #monitors { display:flex; flex-wrap:wrap; justify-content:center; padding:16px; gap:16px; }
  .monitor { background:#1f1f1f; border-radius:12px; padding:16px; min-width:280px; width:280px; box-shadow:0 4px 12px rgba(0,0,0,0.7); transition:0.3s; border:2px solid transparent; cursor:pointer; }
  .monitor:hover, .monitor.active { border-color:#00aaff; }
  .monitor.alarm { border-color:#ff4d4d; }

  .hat-title { font-size:20px; font-weight:600; margin-bottom:10px; text-align:center; letter-spacing:1px; }
  table { width:100%; border-collapse:collapse; }
  th, td { border:1px solid #333; padding:8px; text-align:center; font-size:14px; }
  th { background:#2a2a2a; }
  .val { font-weight:500; }
  .led { width:14px; height:14px; border-radius:50%; display:inline-block; margin-left:6px; vertical-align:middle; background:gray; transition:0.3s; }
  .led.pulse { animation: pulse 0.5s; }
  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }

  .offline-banner { color:#ffcc00; font-weight:700; margin-top:12px; text-align:center; font-size:14px; }
  footer { text-align:center; font-size:12px; color:#888; margin-top:16px; }

  @media(max-width:900px){ #monitors{justify-content:space-around;} }
  @media(max-width:600px){ #monitors{flex-direction:column; align-items:center;} }
</style>
</head>
<body>
<header>
  AkÄ±llÄ± DC GÃ¼Ã§ Ãœnitesi MonitÃ¶rÃ¼
  <button id="toggleRelay">RÃ¶le AÃ§/Kapa</button>
  <div id="clock"></div>
  <div id="connection"></div>
</header>

<div id="monitors"></div>
<footer>Son gÃ¼ncelleme: <span id="lastUpdate">-</span></footer>

<script>
const monitors = ["MonitÃ¶r1","MonitÃ¶r2","MonitÃ¶r3","MonitÃ¶r4"];

function updateClock(){
  document.getElementById("clock").innerText = new Date().toLocaleTimeString();
}
setInterval(updateClock,1000);

function createMonitorHTML(monitorId, index){
  const container = document.createElement("div");
  container.className="monitor"; container.id=monitorId;

  const title = document.createElement("div");
  title.className="hat-title"; title.innerText = monitorId; container.appendChild(title);

  const table = document.createElement("table");
  const header = document.createElement("tr");
  ["Hat","SÄ±caklÄ±k (Â°C)","AkÄ±m (A)","Gerilim (V)","GÃ¼Ã§ (W)"].forEach(h=>{
    const th=document.createElement("th"); th.innerText=h; header.appendChild(th);
  });
  table.appendChild(header);

  const tr = document.createElement("tr"); tr.id = monitorId + "_hat1";
  const tdHat = document.createElement("td"); tdHat.innerText = "Hat " + (index+1); tr.appendChild(tdHat);
  for(let i=0;i<4;i++){
    const td=document.createElement("td"); td.innerHTML='<span class="val">-</span> <span class="led"></span>'; tr.appendChild(td);
  }
  table.appendChild(tr);
  container.appendChild(table);

  const offlineDiv=document.createElement("div");
  offlineDiv.className="offline-banner"; offlineDiv.id=monitorId+"_offline"; offlineDiv.innerText="BaÄŸlantÄ± yok";
  container.appendChild(offlineDiv);

  container.addEventListener("click",()=>{ container.classList.add("active"); setTimeout(()=>container.classList.remove("active"),500); });
  document.getElementById("monitors").appendChild(container);
}

monitors.forEach((m,i)=>createMonitorHTML(m,i));

function toFullDate(ts){ const d = new Date(ts); return d.toLocaleDateString()+" "+d.toLocaleTimeString(); }

const protocol = (location.protocol==="https:")?"wss:":"ws:";
const WS_URL = protocol+"//"+location.host;
const socket = new WebSocket(WS_URL);
const OFFLINE_THRESHOLD = 10000;
let lastTs=0;

function resetMonitors(){
  monitors.forEach(m=>{
    const rowEl=document.getElementById(m+"_hat1");
    const tds=rowEl.getElementsByTagName("td");
    for(let i=1;i<=4;i++){ tds[i].querySelector(".val").innerText="-"; tds[i].querySelector(".led").style.background="gray"; }
    document.getElementById(m).classList.remove("alarm");
    document.getElementById(m+"_offline").innerText="BaÄŸlantÄ± yok";
  });
}

socket.addEventListener("open",()=>{ document.getElementById("connection").style.background="limegreen"; resetMonitors(); });
socket.addEventListener("close",()=>{ makeAllOffline(); });
socket.addEventListener("message",(e)=>{
  try{
    const msg=JSON.parse(e.data);
    if(msg.type==="init" || msg.type==="update"){
      lastTs = msg.ts || Date.now();
      document.getElementById("lastUpdate").innerText = toFullDate(lastTs);
      document.getElementById("connection").style.background="limegreen";
      applyDataToUI(msg.data||{});
      clearOfflineFlags();
    } else if(msg.type==="offline"){ makeAllOffline(); }
  } catch(err){ console.error(err); }
});

function applyDataToUI(rootData){
  monitors.forEach((m,i)=>{
    const rowEl=document.getElementById(m+"_hat1");
    const tds=rowEl.getElementsByTagName("td");
    const hatData=rootData["monitor"+(i+1)]?.["hat1"];
    const container = document.getElementById(m);
    if(!hatData){ for(let j=1;j<=4;j++){ tds[j].querySelector(".val").innerText="-"; tds[j].querySelector(".led").style.background="gray"; } container.classList.remove("alarm"); return; }

    updateCell(tds[1], hatData.temperature?.value, hatData.temperature?.alert);
    updateCell(tds[2], hatData.current?.value, hatData.current?.alert);
    updateCell(tds[3], hatData.voltage?.value, hatData.voltage?.alert);
    updateCell(tds[4], hatData.power?.value, hatData.power?.alert);

    if(hatData.temperature?.alert || hatData.current?.alert || hatData.voltage?.alert || hatData.power?.alert){
      container.classList.add("alarm");
    } else container.classList.remove("alarm");
  });
}

function updateCell(td, value, alert){
  const valSpan=td.querySelector(".val");
  const led=td.querySelector(".led");
  const oldValue = valSpan.innerText;
  const newValue = (value===null || value===-1)?"-":Number(value).toFixed(2);
  if(oldValue!==newValue){ valSpan.innerText=newValue; led.style.background = alert ? "red" : "limegreen"; led.classList.add("pulse"); setTimeout(()=>led.classList.remove("pulse"),500); }
}

function makeAllOffline(){
  monitors.forEach((m)=>{
    const rowEl=document.getElementById(m+"_hat1");
    const tds=rowEl.getElementsByTagName("td");
    for(let i=1;i<=4;i++){ tds[i].querySelector(".val").innerText="-"; tds[i].querySelector(".led").style.background="gray"; }
    document.getElementById(m+"_offline").innerText="BaÄŸlantÄ± yok";
    document.getElementById(m).classList.remove("alarm");
  });
  document.getElementById("connection").style.background="red";
}

function clearOfflineFlags(){ monitors.forEach(m=>document.getElementById(m+"_offline").innerText=""); }

setInterval(()=>{ if(Date.now()-lastTs > OFFLINE_THRESHOLD){ makeAllOffline(); } },2000);

// ðŸ”¹ RÃ¶le toggle butonu
document.getElementById("toggleRelay").addEventListener("click", async ()=>{
  try{
    const res = await fetch("/api/toggle",{ method:"POST" });
    const data = await res.json();
    alert("RÃ¶le durumu: "+data.status);
  } catch(err){ console.error(err); alert("RÃ¶le komutu gÃ¶nderilemedi!"); }
});
</script>
</body>
</html>
