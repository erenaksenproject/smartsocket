<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<title>AkÄ±llÄ± DC GÃ¼Ã§ Ãœnitesi</title>

<!-- Logo favicon -->
<link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/thumb/2/29/D%C3%BCzce_University_logo.svg/1200px-D%C3%BCzce_University_logo.svg.png">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* ------------ GLOBAL VARIABLES ------------ */
  body{
    font-family:'Segoe UI',Arial,sans-serif;
    margin:0;padding:0;
    --bg:#eef2f6;--text:#111;
    --card:rgba(255,255,255,0.6);
    --border:rgba(255,255,255,0.5);
  }
  body.dark{
    --bg:#0b0c0e;--text:#eee;
    --card:rgba(20,20,20,0.48);
    --border:rgba(255,255,255,0.06);
  }
  body{
    background:var(--bg);
    color:var(--text);
  }

  /* ------------ LOGIN SCREEN ------------ */
  #loginScreen{
    position:fixed;
    inset:0;
    background:var(--bg);
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    gap:18px;
  }
  #loginBox{
    background:var(--card);
    border:1px solid var(--border);
    padding:22px 28px;
    border-radius:14px;
    width:300px;
    display:flex;
    flex-direction:column;
    gap:12px;
    text-align:center;
  }
  #loginBox input{
    padding:10px;
    border-radius:8px;
    border:1px solid var(--border);
    width:100%;
  }
  #loginBox button{
    padding:10px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    background:#1E88E5;
    color:white;
    font-size:15px;
    font-weight:600;
  }
  #blockMsg{
    color:#c62828;
    font-size:13px;
  }
  .logoutBtn{
    cursor:pointer;
    font-size:15px;
    padding:6px 10px;
    border-radius:8px;
    border:1px solid var(--border);
    background:var(--card);
  }

  /* ---------------------------------- DASHBOARD CSS (SENÄ°N KODUN) ---------------------------------- */
  .header{display:flex;justify-content:space-between;align-items:center;max-width:1200px;margin:0 auto 12px;padding:14px;}
  .title{display:flex;flex-direction:column;font-weight:700;}
  .subtitle{font-size:12px;opacity:0.75;margin-top:4px;}
  .right-controls{display:flex;align-items:center;gap:12px;}
  .clock{font-size:16px;font-weight:600;padding:8px 12px;border-radius:10px;background:var(--card);border:1px solid var(--border);}
  .lastData{font-size:12px;opacity:0.85;margin-top:6px;}
  .themeToggle{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:var(--card);cursor:pointer;font-size:14px;}

  .summary{max-width:1200px;margin:8px auto;display:flex;gap:12px;justify-content:center;flex-wrap:wrap;padding:0 14px;}
  .sum-card{background:var(--card);border:1px solid var(--border);padding:12px 16px;border-radius:12px;min-width:120px;text-align:center;}
  .sum-label{font-size:12px;opacity:0.75;}
  .sum-val{font-size:18px;font-weight:700;margin-top:6px;}

  .grid{max-width:1200px;margin:14px auto;display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:0 14px;}
  @media(max-width:800px){.grid{grid-template-columns:1fr;}}

  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);transform-origin:top;transform:scale(0.9);}
  .card:hover{transform:scale(0.94);}
  .card-title{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;font-weight:700;font-size:15px;}
  .status-dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-left:8px;}
  .values-row{display:flex;justify-content:space-between;gap:10px;margin-bottom:8px;}
  .val-box{text-align:center;flex:1;}
  .val-num{font-weight:800;font-size:16px;display:flex;align-items:center;justify-content:center;gap:8px;}
  .val-label{font-size:12px;opacity:0.75;margin-top:4px;}
  .tiny{font-size:12px;opacity:0.7;}

  .flash-up{animation:flashGreen 420ms ease;}
  .flash-down{animation:flashRed 420ms ease;}

  @keyframes flashGreen{
    0%{color:#00e676;text-shadow:0 0 8px #00e676}
    100%{color:inherit;text-shadow:none}
  }
  @keyframes flashRed{
    0%{color:#ff3b30;text-shadow:0 0 8px #ff3b30}
    100%{color:inherit;text-shadow:none}
  }

</style>
</head>
<body>

<!-- ========================== LOGIN SCREEN ========================== -->
<div id="loginScreen">
  
  <!-- Logo -->
  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/29/D%C3%BCzce_University_logo.svg/1200px-D%C3%BCzce_University_logo.svg.png"
       style="width:110px; margin-bottom:10px;">

  <div id="loginBox">
    <h3>GiriÅŸ Yap</h3>
    <input id="username" placeholder="KullanÄ±cÄ± adÄ±">
    <input id="password" type="password" placeholder="Åžifre">
    <button onclick="handleLogin()">GiriÅŸ</button>
    <div id="loginError" style="color:#c62828;font-size:13px;"></div>
    <div id="blockMsg"></div>
  </div>
</div>


<!-- ========================== DASHBOARD (SENÄ°N SÄ°STEMÄ°N) ========================== -->
<div id="dashboard" style="display:none;">

  <div class="header">
    <div class="title">
      <div>AkÄ±llÄ± DC GÃ¼Ã§ Ãœnitesi</div>
      <div class="subtitle" id="globalStatusText">BaÄŸlantÄ± kontrol ediliyor...</div>
    </div>

    <div class="right-controls">
      <div class="clock" id="realtimeClock">--:--:--</div>
      <button class="themeToggle" id="themeToggle">ðŸŒ™</button>

      <button class="logoutBtn" onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>

      <div style="display:flex;flex-direction:column;align-items:center;">
        <div class="lastData tiny" id="lastDataTs">Son veri: â€”</div>
      </div>
    </div>
  </div>


  <div class="summary">
    <div class="sum-card"><div class="sum-label">Toplam Voltaj</div><div class="sum-val" id="sumV">0.0 V</div></div>
    <div class="sum-card"><div class="sum-label">Toplam AkÄ±m</div><div class="sum-val" id="sumA">0.00 A</div></div>
    <div class="sum-card"><div class="sum-label">Toplam GÃ¼Ã§</div><div class="sum-val" id="sumW">0.0 W</div></div>
  </div>

  <div class="grid" id="grid"></div>

</div>


<script>
/* ====================== LOGIN LOGIC ====================== */

const CORRECT_USER = "smartsocket";
const CORRECT_PASS = "panelpassword81";

let failCount = 0;
let blockedUntil = 0;

function handleLogin(){
  const now = Date.now();

  if(now < blockedUntil){
    document.getElementById("blockMsg").innerText =
      "Ã‡ok fazla deneme! " + Math.ceil((blockedUntil - now)/1000) +
      " saniye sonra tekrar deneyin.";
    return;
  }

  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value;

  if(u === CORRECT_USER && p === CORRECT_PASS){
    failCount = 0;
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("dashboard").style.display = "block";
    return;
  }

  failCount++;
  document.getElementById("loginError").innerText = "HatalÄ± kullanÄ±cÄ± adÄ± veya ÅŸifre!";

  if(failCount >= 3){
    blockedUntil = Date.now() + 30000; // 30 saniye
    failCount = 0;
    document.getElementById("blockMsg").innerText =
      "Hesap 30 saniyeliÄŸine bloke edildi!";
  }
}

function logout(){
  alert("GÃ¼Ã§ Ã¼nitesinden ayrÄ±lÄ±nÄ±yor...");
  document.getElementById("dashboard").style.display = "none";
  document.getElementById("loginScreen").style.display = "flex";
}


/* ====================== THEME SWITCH ====================== */
document.getElementById("themeToggle").onclick = ()=>{
  document.body.classList.toggle("dark");
  document.getElementById("themeToggle").innerText =
    document.body.classList.contains("dark") ? "â˜€ï¸" : "ðŸŒ™";
};


/* ====================== DASHBOARD (SENÄ°N ORÄ°JÄ°NAL KODUN) ====================== */

const MON_NAMES=["DC Soket Ã‡Ä±kÄ±ÅŸÄ± 1","DC Soket Ã‡Ä±kÄ±ÅŸÄ± 2","USB-A Portu 1","USB-A Portu 2"];
const OFFLINE_THRESHOLD=10000;
let grid=document.getElementById("grid");
let charts=[],lastReceived=[],lastGlobal=Date.now();

/* clock */
setInterval(()=>{document.getElementById("realtimeClock").innerText=new Date().toLocaleTimeString();},1000);

/* build monitor cards */
for(let i=0;i<MON_NAMES.length;i++){
  const id="mon"+i;
  const html=`<div class="card" id="${id}">
    <div class="card-title">
      <strong>${MON_NAMES[i]}</strong>
      <div id="dot${i}" class="status-dot" style="background:#f44;"></div>
    </div>
    <div class="values-row">
      <div class="val-box"><div class="val-num"><span class="ic">ðŸ”‹</span><span id="v${i}">--</span></div><div class="val-label">Volt (V)</div></div>
      <div class="val-box"><div class="val-num"><span class="ic">ðŸ§²</span><span id="a${i}">--</span></div><div class="val-label">AkÄ±m (A)</div></div>
      <div class="val-box"><div class="val-num"><span class="ic">âš¡</span><span id="w${i}">--</span></div><div class="val-label">GÃ¼Ã§ (W)</div></div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div class="tiny">SÄ±caklÄ±k: <span id="t${i}">--</span>Â°C</div>
      <div class="tiny status-text" id="stat${i}">Durum: â€”</div>
    </div>
    <canvas id="chart${i}" height="110"></canvas>
  </div>`;
  const div=document.createElement("div"); div.innerHTML=html; grid.appendChild(div.firstElementChild);
  lastReceived[i]=0;
}

/* charts */
for(let i=0;i<MON_NAMES.length;i++){
  const ctx=document.getElementById("chart"+i).getContext("2d");
  charts[i]=new Chart(ctx,{
    type:'line',
    data:{
      labels:[],
      datasets:[
        {label:'Volt (V)',data:[],borderColor:'#1E90FF',backgroundColor:'rgba(30,144,255,0.06)',tension:0.25,pointRadius:0},
        {label:'AkÄ±m (A)',data:[],borderColor:'#FF3B30',backgroundColor:'rgba(255,59,48,0.06)',tension:0.25,pointRadius:0},
        {label:'GÃ¼Ã§ (W)',data:[],borderColor:'#00C853',backgroundColor:'rgba(0,200,83,0.06)',tension:0.25,pointRadius:0}
      ]
    },
    options:{animation:false,plugins:{legend:{display:true}},scales:{x:{display:false}}}
  });
}


function fmtTs(ts){ if(!ts) return "â€”"; const d=new Date(ts); return d.toLocaleDateString()+" "+d.toLocaleTimeString(); }

function flash(el,type){
  el.classList.remove("flash-up","flash-down");
  void el.offsetWidth;
  el.classList.add(type==="up"?"flash-up":"flash-down");
  setTimeout(()=>{el.classList.remove("flash-up","flash-down");},400);
}


/* websocket */
const protocol=(location.protocol==="https:")?"wss:":"ws:";
const WS_URL=protocol+"//"+location.host;
const socket=new WebSocket(WS_URL);

let lastTs=0;

socket.addEventListener("message",(e)=>{
  try{
    const msg=JSON.parse(e.data);
    if(msg.type==="init"||msg.type==="update"){
      lastTs=msg.ts||Date.now();
      document.getElementById("lastDataTs").innerText="Son veri: "+fmtTs(lastTs);
      processData(msg.data||{});
    }else if(msg.type==="offline"){ makeAllOffline(); }
  }catch(err){console.error(err);}
});


function processData(obj){
  let totalV=0,totalA=0,totalW=0;
  let anyActive=false;

  for(let i=0;i<MON_NAMES.length;i++){
    const d=obj["monitor"+(i+1)]?.hat1;
    const vEl=document.getElementById("v"+i);
    const aEl=document.getElementById("a"+i);
    const wEl=document.getElementById("w"+i);
    const tEl=document.getElementById("t"+i);
    const statEl=document.getElementById("stat"+i);
    const dotEl=document.getElementById("dot"+i);
    const ch=charts[i];

    if(!d){
      vEl.innerText=aEl.innerText=wEl.innerText=tEl.innerText="-";
      statEl.innerText="BaÄŸlantÄ± yok â€” kontrol edilmeli";
      dotEl.style.background="red";
      continue;
    }

    const v=d.voltage.value, a=d.current.value, w=d.power.value;

    vEl.innerText=v.toFixed(2);
    aEl.innerText=a.toFixed(3);
    wEl.innerText=w.toFixed(2);
    tEl.innerText=d.temperature.value.toFixed(1);

    flash(vEl,v>"oldV"?"up":"down");
    flash(aEl,a>"oldA"?"up":"down");
    flash(wEl,w>"oldW"?"up":"down");

    /* Energy check */
    if(a<0.005 || w<0.05){
      statEl.innerText="Enerji yok âš ï¸";
      dotEl.style.background="#ff9800";
    }else{
      statEl.innerText="BaÄŸlantÄ±: Aktif";
      dotEl.style.background="#0f0";
      anyActive=true;
    }

    if(ch.data.labels.length>=30){
      ch.data.labels.shift();
      ch.data.datasets.forEach(ds=>ds.data.shift());
    }
    ch.data.labels.push("");
    ch.data.datasets[0].data.push(v);
    ch.data.datasets[1].data.push(a);
    ch.data.datasets[2].data.push(w);
    ch.update("none");

    totalV+=v; totalA+=a; totalW+=w;
    lastReceived[i]=Date.now();
  }

  document.getElementById("sumV").innerText=totalV.toFixed(2)+" V";
  document.getElementById("sumA").innerText=totalA.toFixed(3)+" A";
  document.getElementById("sumW").innerText=totalW.toFixed(2)+" W";

  const globalEl=document.getElementById("globalStatusText");

  if(anyActive) globalEl.innerText="BaÄŸlantÄ± baÅŸarÄ±lÄ±";
  else if(Date.now()-lastTs>OFFLINE_THRESHOLD) globalEl.innerText="Sistem ile iletiÅŸim yok";
  else globalEl.innerText="BaÄŸlantÄ± kontrol ediliyor...";
}


function makeAllOffline(){
  MON_NAMES.forEach((m,i)=>{
    document.getElementById("v"+i).innerText="-";
    document.getElementById("a"+i).innerText="-";
    document.getElementById("w"+i).innerText="-";
    document.getElementById("t"+i).innerText="-";
    document.getElementById("stat"+i).innerText="Sistem ile iletiÅŸim yok";
    document.getElementById("dot"+i).style.background="red";
  });

  document.getElementById("globalStatusText").innerText="Sistem ile iletiÅŸim yok";
}

setInterval(()=>{
  if(Date.now()-lastTs>OFFLINE_THRESHOLD){
    makeAllOffline();
  }
},1000);

</script>

</body>
</html>
