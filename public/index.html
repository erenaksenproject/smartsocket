<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Akıllı DC Güç Ünitesi</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body {
    font-family:'Segoe UI',Arial;
    background:#121212;
    color:#e0e0e0;
    margin:0;
  }

  header {
    padding:12px 0;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
    background:#1f1f1f;
    font-size:26px;
    font-weight:bold;
    box-shadow:0 2px 6px rgba(0,0,0,0.5);
  }

  #clock { font-size:18px; color:#cfcfcf; }
  #connection { width:14px; height:14px; border-radius:50%; background:red; }

  #monitors {
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    padding:16px;
    gap:16px;
  }

  .monitor {
    background:#1f1f1f;
    border-radius:12px;
    padding:16px;
    width:280px;
    box-shadow:0 4px 12px rgba(0,0,0,0.7);
    border:2px solid transparent;
    transition:0.3s;
    outline:none;
  }

  /* Tıklanınca mavi çerçeve */
  .monitor:focus {
    border-color:#008cff;
    box-shadow:0 0 8px #008cff;
  }

  .monitor.alarm { border-color:#ff4d4d; }

  /* Uyanma animasyonu */
  .wake {
    animation: wakePulse 1.2s infinite;
    border-color:#00aaff !important;
  }
  @keyframes wakePulse {
    0% { box-shadow:0 0 4px #00aaff; }
    50% { box-shadow:0 0 20px #00aaff; }
    100% { box-shadow:0 0 4px #00aaff; }
  }

  .hat-title {
    font-size:20px;
    font-weight:600;
    margin-bottom:10px;
    text-align:center;
  }

  table {
    width:100%;
    border-collapse:collapse;
    text-align:center;
  }

  th {
    background:#2a2a2a;
    border:1px solid #333;
    padding:8px;
    text-align:center;
    font-weight:600;
  }

  td {
    border:1px solid #333;
    padding:8px;
    text-align:center;
  }

  /* Değer + LED hizası düzeltildi */
  .cellwrap {
    display:flex;
    justify-content:center;
    align-items:center;
    gap:6px;
  }

  .val { font-weight:500; }
  .led { width:14px; height:14px; border-radius:50%; background:gray; }

  .offline-banner {
    text-align:center;
    margin-top:10px;
    font-size:14px;
    color:#ffcc00;
  }

  footer {
    text-align:center;
    margin-top:16px;
    font-size:12px;
    color:#888;
  }
</style>
</head>
<body>
<header>
  Akıllı DC Güç Ünitesi Monitörü
  <div id="clock"></div>
  <div id="connection"></div>
</header>

<div id="monitors"></div>

<footer>Son güncelleme: <span id="lastUpdate">-</span></footer>

<script>
let wakeMode = false;
let firstPacketSkipped = true;

let clockEl=document.getElementById("clock");
function updateClock(){ clockEl.innerText=new Date().toLocaleTimeString(); }
setInterval(updateClock,1000);

const monitors=["Monitör1","Monitör2","Monitör3","Monitör4"];

function createMonitorHTML(name,index){
  const c=document.createElement("div");
  c.className="monitor";
  c.id=name;
  c.setAttribute("tabindex","0");

  const title=document.createElement("div");
  title.className="hat-title";
  title.innerText=name;
  c.appendChild(title);

  const tbl=document.createElement("table");
  const headerRow=document.createElement("tr");

  ["Hat","Sıcaklık (°C)","Akım (A)","Gerilim (V)","Güç (W)"].forEach(h=>{
    let th=document.createElement("th");
    th.innerText=h;
    headerRow.appendChild(th);
  });

  tbl.appendChild(headerRow);

  const row=document.createElement("tr");
  row.id=name+"_hat1";

  let tdHat=document.createElement("td");
  tdHat.innerText="Hat "+(index+1);
  row.appendChild(tdHat);

  for(let i=0;i<4;i++){
    let td=document.createElement("td");
    td.innerHTML=`<div class="cellwrap"><span class="val">00.00</span><span class="led"></span></div>`;
    row.appendChild(td);
  }

  tbl.appendChild(row);
  c.appendChild(tbl);

  const offline=document.createElement("div");
  offline.className="offline-banner";
  offline.id=name+"_offline";
  offline.innerText="Bağlantı yok";
  c.appendChild(offline);

  document.getElementById("monitors").appendChild(c);
}

monitors.forEach(createMonitorHTML);

const protocol=(location.protocol==="https:")?"wss:":"ws:";
const socket=new WebSocket(protocol+"//"+location.host);

let lastTs=0;
const OFFLINE_THRESHOLD=10000;

socket.addEventListener("open",()=>{
  document.getElementById("connection").style.background="orange";
  wakeMode = true;
  firstPacketSkipped = false;

  monitors.forEach(m=>{
    document.getElementById(m).classList.add("wake");
    document.getElementById(m+"_offline").innerText="Sistem uyanıyor...";
  });
});

socket.addEventListener("message",(e)=>{
  const msg=JSON.parse(e.data);

  if(!firstPacketSkipped){
    firstPacketSkipped=true;
    return;
  }

  if(wakeMode){
    exitWakeMode();
  }

  if(msg.type==="init" || msg.type==="update"){
    lastTs = msg.ts || Date.now();
    document.getElementById("lastUpdate").innerText = new Date(lastTs).toLocaleTimeString();
    document.getElementById("connection").style.background="limegreen";

    monitors.forEach(m=>{
      document.getElementById(m+"_offline").innerText="";
    });

    applyData(msg.data);
  }
});

socket.addEventListener("close",()=>makeAllOffline());

function exitWakeMode(){
  wakeMode=false;
  monitors.forEach(m=>{
    let el=document.getElementById(m);
    el.classList.remove("wake");
    document.getElementById(m+"_offline").innerText="";
  });
}

function applyData(data){
  monitors.forEach((m,i)=>{
    const d=data["monitor"+(i+1)]?.hat1;
    const row=document.getElementById(m+"_hat1");
    const tds=row.getElementsByTagName("td");
    const cont=document.getElementById(m);

    if(!d) return;

    updateCell(tds[1], d.temperature.value, d.temperature.alert);
    updateCell(tds[2], d.current.value, d.current.alert);
    updateCell(tds[3], d.voltage.value, d.voltage.alert);
    updateCell(tds[4], d.power.value, d.power.alert);

    if(d.temperature.alert || d.current.alert || d.voltage.alert || d.power.alert)
      cont.classList.add("alarm");
    else
      cont.classList.remove("alarm");
  });
}

function updateCell(td,value,alert){
  const span=td.querySelector(".val");
  const led=td.querySelector(".led");

  const v = (value===null || Number.isNaN(value)) ? "00.00" : Number(value).toFixed(2);
  span.innerText=v;
  led.style.background = alert ? "red" : "limegreen";
}

function makeAllOffline(){
  monitors.forEach(m=>{
    document.getElementById(m+"_offline").innerText="Bağlantı yok";
    document.getElementById(m).classList.remove("alarm");
  });
  document.getElementById("connection").style.background="red";
}

setInterval(()=>{
  if(Date.now()-lastTs > OFFLINE_THRESHOLD){
    makeAllOffline();
  }
},2000);
</script>

</body>
</html>
