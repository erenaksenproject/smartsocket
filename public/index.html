<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Akƒ±llƒ± DC G√º√ß √únitesi</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* =========================================================
   THEME & GLOBAL STYLES
========================================================= */
body{
  font-family:'Segoe UI',Arial,sans-serif;
  margin:0; padding:0;
  --bg:#eef2f6; --text:#111;
  --card:rgba(255,255,255,0.6);
  --border:rgba(255,255,255,0.5);
  background:var(--bg); color:var(--text);
}
body.dark{
  --bg:#0b0c0e; --text:#eee;
  --card:rgba(20,20,20,0.48);
  --border:rgba(255,255,255,0.06);
}

/* =========================================================
   LOGIN PAGE
========================================================= */
#loginPage{
  position:fixed; inset:0;
  display:flex; flex-direction:column;
  justify-content:center; align-items:center;
  background:var(--bg);
  z-index:20;
}
#loginBox{
  background:var(--card);
  border:1px solid var(--border);
  padding:24px 30px;
  border-radius:14px;
  width:330px;
  box-shadow:0 8px 25px rgba(0,0,0,0.12);
}
#loginBox h2{
  margin-top:0; margin-bottom:14px;
  text-align:center;
}
.loginInput{
  width:100%; padding:10px;
  margin-top:8px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  font-size:15px;
}
#loginBtn{
  width:100%; padding:10px;
  margin-top:18px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  background:#1976d2;
  color:white;
  font-size:16px;
  font-weight:600;
}
#loginError{
  color:#e53935;
  margin-top:12px;
  text-align:center;
  font-size:14px;
}

/* =========================================================
   LOGOUT MODAL
========================================================= */
#logoutModal{
  position:fixed;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  background:rgba(0,0,0,0.55);
  backdrop-filter:blur(4px);
  z-index:30;
  opacity:0; pointer-events:none;
  transition:opacity .3s ease;
}
#logoutModal.show{
  opacity:1; pointer-events:auto;
}
.logoutBox{
  background:var(--card);
  border:1px solid var(--border);
  padding:24px 26px;
  border-radius:14px;
  text-align:center;
  box-shadow:0 8px 28px rgba(0,0,0,0.25);
  animation:scaleIn 0.35s ease;
}
@keyframes scaleIn{
  0%{transform:scale(.85); opacity:0}
  100%{transform:scale(1); opacity:1}
}

/* =========================================================
   DASHBOARD LAYOUT
========================================================= */
.header{
  display:flex; justify-content:space-between; align-items:center;
  max-width:1200px; margin:0 auto 12px; padding:14px;
}
.title{display:flex; flex-direction:column; font-weight:700;}
.subtitle{font-size:12px; opacity:0.75; margin-top:4px;}
.right-controls{display:flex; align-items:center; gap:12px;}
.clock{font-size:16px; font-weight:600; padding:8px 12px; border-radius:10px;
       background:var(--card); border:1px solid var(--border);}
.lastData{font-size:12px; opacity:0.85; margin-top:6px;}
.themeToggle{
  padding:6px 10px; border-radius:6px; border:1px solid var(--border);
  background:var(--card); cursor:pointer; font-size:14px;
}

/* LOGOUT BUTTON */
#logoutBtn{
  padding:6px 10px;
  border-radius:6px;
  border:1px solid #d32f2f;
  background:#ff5252;
  color:white;
  font-weight:600;
  font-size:15px;
  cursor:pointer;
  display:flex; align-items:center; gap:6px;
}
#logoutBtn:hover{
  background:#e53935;
}

/* SUMMARY CARDS */
.summary{
  max-width:1200px; margin:8px auto;
  display:flex; gap:12px; justify-content:center; flex-wrap:wrap;
}
.sum-card{
  background:var(--card); border:1px solid var(--border);
  padding:12px 16px; border-radius:12px;
  min-width:120px; text-align:center;
}
.sum-label{font-size:12px; opacity:.75;}
.sum-val{font-size:18px; font-weight:700; margin-top:6px;}

/* MONITOR CARDS */
.grid{
  max-width:1200px; margin:14px auto;
  display:grid; grid-template-columns:repeat(2,1fr);
  gap:16px; padding:0 6px;
}
@media(max-width:800px){.grid{grid-template-columns:1fr;}}

.card{
  background:var(--card); border:1px solid var(--border); border-radius:14px;
  padding:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06);
  transform-origin:top; transform:scale(0.9);
}
.card:hover{transform:scale(0.94);}
.card-title{display:flex; justify-content:space-between; align-items:center;
            font-weight:700; font-size:15px; margin-bottom:8px;}
.status-dot{
  width:12px; height:12px; border-radius:50%; margin-left:8px;
}
.values-row{display:flex; justify-content:space-between; gap:10px; margin-bottom:8px;}
.val-box{text-align:center; flex:1;}
.val-num{font-weight:800; font-size:16px; display:flex; align-items:center; justify-content:center; gap:8px;}
.val-label{font-size:12px; opacity:0.75; margin-top:4px;}
.tiny{font-size:12px; opacity:0.7;}
.flash-up{animation:flashGreen 420ms ease;}
.flash-down{animation:flashRed 420ms ease;}

@keyframes flashGreen{0%{color:#00e676; text-shadow:0 0 8px #00e676;}100%{color:inherit; text-shadow:none;}}
@keyframes flashRed{0%{color:#ff3b30; text-shadow:0 0 8px #ff3b30;}100%{color:inherit; text-shadow:none;}}

.status-text{font-size:13px; margin-top:6px;}
.ic{width:16px; height:16px;}

/* HIDE DASHBOARD INITIALLY */
#dashboard{display:none;}
</style>
</head>
<body>

<!-- =========================================================
     LOGIN PAGE
========================================================= -->
<div id="loginPage">
  <div id="loginBox">
    <h2>Giri≈ü Yap</h2>
    <input id="user" class="loginInput" placeholder="Kullanƒ±cƒ± adƒ±"/>
    <input id="pass" type="password" class="loginInput" placeholder="≈ûifre"/>
    <button id="loginBtn">Giri≈ü Yap</button>
    <div id="loginError"></div>
  </div>
</div>

<!-- =========================================================
     LOGOUT MODAL
========================================================= -->
<div id="logoutModal">
  <div class="logoutBox">
    <h3>üîê Sistemden √ßƒ±kƒ±lƒ±yor...</h3>
  </div>
</div>

<!-- =========================================================
     DASHBOARD PAGE
========================================================= -->
<div id="dashboard">

<div class="header">
  <div class="title">
    <div>Akƒ±llƒ± DC G√º√ß √únitesi</div>
    <div class="subtitle" id="globalStatusText">Baƒülantƒ± kontrol ediliyor...</div>
  </div>

  <div class="right-controls">
    <div class="clock" id="realtimeClock">--:--:--</div>
    <button class="themeToggle" id="themeToggle">üåô</button>

    <!-- √áƒ±kƒ±≈ü butonu -->
    <button id="logoutBtn">üö™ √áƒ±kƒ±≈ü</button>

    <div style="display:flex;flex-direction:column;align-items:center;">
      <div class="lastData tiny" id="lastDataTs">Son veri: ‚Äî</div>
    </div>
  </div>
</div>

<div class="summary">
  <div class="sum-card"><div class="sum-label">Toplam Voltaj</div><div class="sum-val" id="sumV">0.0 V</div></div>
  <div class="sum-card"><div class="sum-label">Toplam Akƒ±m</div><div class="sum-val" id="sumA">0.00 A</div></div>
  <div class="sum-card"><div class="sum-label">Toplam G√º√ß</div><div class="sum-val" id="sumW">0.0 W</div></div>
</div>

<div class="grid" id="grid"></div>
</div>

<script>
/* =========================================================
   LOGIN SYSTEM
========================================================= */
const VALID_USER = "smartsocketproject";
const VALID_PASS = "locationpassword81";
let attempts = 0;
let blockedUntil = 0;

function showLoginError(msg){
  document.getElementById("loginError").innerText = msg;
}

document.getElementById("loginBtn").onclick = () => {
  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value.trim();
  const now = Date.now();

  if(now < blockedUntil){
    showLoginError("√áok fazla deneme! L√ºtfen 30 saniye bekleyin.");
    return;
  }

  if(u === VALID_USER && p === VALID_PASS){
    document.getElementById("loginPage").style.display="none";
    document.getElementById("dashboard").style.display="block";
    showLoginError("");
    attempts = 0;
    return;
  }

  attempts++;
  if(attempts >= 3){
    blockedUntil = now + 30000;
    showLoginError("3 yanlƒ±≈ü deneme! 30 saniye giri≈ü engellendi.");
  } else {
    showLoginError("Hatalƒ± kullanƒ±cƒ± adƒ± veya ≈üifre.");
  }
};

/* LOGOUT BUTTON */
document.getElementById("logoutBtn").onclick = () => {
  const modal = document.getElementById("logoutModal");
  modal.classList.add("show");

  setTimeout(()=>{
    modal.classList.remove("show");
    document.getElementById("dashboard").style.display="none";
    document.getElementById("loginPage").style.display="flex";
    document.getElementById("user").value="";
    document.getElementById("pass").value="";
  },1200);
};

/* =========================================================
   DASHBOARD SCRIPT
========================================================= */

const MON_NAMES=["DC Soket √áƒ±kƒ±≈üƒ± 1","DC Soket √áƒ±kƒ±≈üƒ± 2","USB-A Portu 1","USB-A Portu 2"];
const OFFLINE_THRESHOLD=10000;
let grid=document.getElementById("grid");
let charts=[], lastReceived=[], lastGlobal=Date.now();

/* Clock */
setInterval(()=>{ document.getElementById("realtimeClock").innerText=new Date().toLocaleTimeString(); },1000);

/* Theme Toggle */
document.getElementById("themeToggle").onclick=()=>{
  document.body.classList.toggle("dark");
  document.getElementById("themeToggle").innerText=
    document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
};

/* Build Monitor Cards */
for(let i=0;i<MON_NAMES.length;i++){
  const id="mon"+i;
  const html=`
    <div class="card" id="${id}">
      <div class="card-title">
        <strong>${MON_NAMES[i]}</strong>
        <div id="dot${i}" class="status-dot" style="background:#f44;"></div>
      </div>
      <div class="values-row">
        <div class="val-box"><div class="val-num">üîã <span id="v${i}">--</span></div><div class="val-label">Volt</div></div>
        <div class="val-box"><div class="val-num">üß≤ <span id="a${i}">--</span></div><div class="val-label">Akƒ±m</div></div>
        <div class="val-box"><div class="val-num">‚ö° <span id="w${i}">--</span></div><div class="val-label">G√º√ß</div></div>
      </div>
      <div style="display:flex;justify-content:space-between;">
        <div class="tiny">Sƒ±caklƒ±k: <span id="t${i}">--</span>¬∞C</div>
        <div class="tiny status-text" id="stat${i}">Durum: ‚Äî</div>
      </div>
      <canvas id="chart${i}" height="110"></canvas>
    </div>`;
  const d=document.createElement("div");
  d.innerHTML=html;
  grid.appendChild(d.firstChild);
  lastReceived[i]=0;
}

/* Create charts */
for(let i=0;i<MON_NAMES.length;i++){
  const ctx=document.getElementById("chart"+i).getContext("2d");
  charts[i]=new Chart(ctx,{
    type:'line',
    data:{labels:[],datasets:[
      {label:"Volt (V)", data:[], borderColor:"#1E90FF", tension:.25, pointRadius:0},
      {label:"Akƒ±m (A)", data:[], borderColor:"#FF3B30", tension:.25, pointRadius:0},
      {label:"G√º√ß (W)", data:[], borderColor:"#00C853", tension:.25, pointRadius:0}
    ]},
    options:{animation:false,plugins:{legend:{display:true}},scales:{x:{display:false}}}
  });
}

function flash(el,type){
  el.classList.remove("flash-up","flash-down");
  void el.offsetWidth;
  el.classList.add(type==="up"?"flash-up":"flash-down");
  setTimeout(()=>el.classList.remove("flash-up","flash-down"),400);
}

function fmtTs(ts){
  if(!ts) return "‚Äî";
  const d=new Date(ts);
  return d.toLocaleDateString()+" "+d.toLocaleTimeString();
}

/* ---------------------------
   WEBSOCKET
---------------------------- */
const protocol=(location.protocol==="https:")?"wss:":"ws:";
const WS_URL=protocol+"//"+location.host;
const socket=new WebSocket(WS_URL);

let lastTs=0;

socket.addEventListener("message",(e)=>{
  try{
    const msg=JSON.parse(e.data);
    if(msg.type==="init"||msg.type==="update"){
      lastTs=msg.ts||Date.now();
      document.getElementById("lastDataTs").innerText="Son veri: "+fmtTs(lastTs);
      processData(msg.data||{});
    }
    else if(msg.type==="offline"){ makeAllOffline(); }
  }catch(err){ console.error(err); }
});

/* ---------------------------
   PROCESS DATA
---------------------------- */
function processData(obj){
  let totalV=0,totalA=0,totalW=0;
  let anyActive=false;

  for(let i=0;i<MON_NAMES.length;i++){
    const d=obj["monitor"+(i+1)]?.hat1 || null;

    const vEl=document.getElementById("v"+i);
    const aEl=document.getElementById("a"+i);
    const wEl=document.getElementById("w"+i);
    const tEl=document.getElementById("t"+i);
    const statEl=document.getElementById("stat"+i);
    const dotEl=document.getElementById("dot"+i);

    if(!d){
      vEl.innerText=aEl.innerText=wEl.innerText=tEl.innerText="-";
      statEl.innerText="Baƒülantƒ± yok ‚Äî kontrol edilmeli";
      dotEl.style.background="red";
      continue;
    }

    const v=d.voltage.value || 0;
    const a=d.current.value || 0;
    const w=d.power.value || 0;
    const temp=d.temperature.value || 0;

    const oldV=parseFloat(vEl.innerText)||0;
    const oldA=parseFloat(aEl.innerText)||0;
    const oldW=parseFloat(wEl.innerText)||0;

    vEl.innerText=v.toFixed(2);
    aEl.innerText=a.toFixed(3);
    wEl.innerText=w.toFixed(2);
    tEl.innerText=temp.toFixed(1);

    flash(vEl,v>oldV?"up":"down");
    flash(aEl,a>oldA?"up":"down");
    flash(wEl,w>oldW?"up":"down");

    /* Enerji yok kontrol√º */
    if(a < 0.005 || w < 0.05){
      statEl.innerText="Enerji yok ‚ö†Ô∏è";
      dotEl.style.background="#ffa726";
    } else {
      statEl.innerText="Baƒülantƒ±: Aktif";
      dotEl.style.background="#0f0";
      anyActive=true;
    }

    /* Chart update */
    const ch=charts[i];
    if(ch.data.labels.length>=30){
      ch.data.labels.shift();
      ch.data.datasets.forEach(ds=>ds.data.shift());
    }
    ch.data.labels.push("");
    ch.data.datasets[0].data.push(v);
    ch.data.datasets[1].data.push(a);
    ch.data.datasets[2].data.push(w);
    ch.update("none");

    totalV+=v;
    totalA+=a;
    totalW+=w;
    lastReceived[i]=Date.now();
  }

  document.getElementById("sumV").innerText=totalV.toFixed(2)+" V";
  document.getElementById("sumA").innerText=totalA.toFixed(3)+" A";
  document.getElementById("sumW").innerText=totalW.toFixed(2)+" W";

  const g=document.getElementById("globalStatusText");
  if(anyActive) g.innerText="Baƒülantƒ± ba≈üarƒ±lƒ±";
  else if(Date.now()-lastTs>OFFLINE_THRESHOLD) g.innerText="Sistem ile ileti≈üim yok";
  else g.innerText="Baƒülantƒ± kontrol ediliyor...";
}

/* OFFLINE HANDLER */
function makeAllOffline(){
  for(let i=0;i<MON_NAMES.length;i++){
    document.getElementById("v"+i).innerText="-";
    document.getElementById("a"+i).innerText="-";
    document.getElementById("w"+i).innerText="-";
    document.getElementById("t"+i).innerText="-";
    document.getElementById("stat"+i).innerText="Sistem ile ileti≈üim yok";
    document.getElementById("dot"+i).style.background="red";
  }
  document.getElementById("globalStatusText").innerText="Sistem ile ileti≈üim yok";
}

setInterval(()=>{ if(Date.now()-lastTs > OFFLINE_THRESHOLD) makeAllOffline(); },1000);
</script>
</body>
</html>
