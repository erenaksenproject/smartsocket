<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Akƒ±llƒ± DC G√º√ß √únitesi</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* ==== LOGIN EKRANI (Koyu Tema, G√º√ß Analiz√∂r√º Havasƒ±) ==== */
  #loginScreen{
    position:fixed;
    inset:0;
    background:#050608;
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:9999;
    color:#eee;
  }
  #loginBox{
    background:#111318;
    border:1px solid #292c34;
    border-radius:14px;
    padding:24px 26px 22px;
    width:320px;
    box-shadow:0 18px 40px rgba(0,0,0,0.7);
    text-align:center;
  }
  #loginLogo{
    width:80px;
    height:80px;
    object-fit:contain;
    margin-bottom:10px;
  }
  #loginBox h2{
    margin:4px 0 2px;
    font-size:19px;
    font-weight:700;
  }
  #loginBox p{
    margin:0 0 12px;
    font-size:12px;
    opacity:0.8;
  }
  #loginBox input{
    width:100%;
    padding:9px 10px;
    margin:6px 0;
    border-radius:8px;
    border:1px solid #3a3f4a;
    background:#05070b;
    color:#eee;
    font-size:14px;
    outline:none;
  }
  #loginBox input:focus{
    border-color:#1976d2;
    box-shadow:0 0 0 1px rgba(25,118,210,0.4);
  }
  #loginBox button{
    width:100%;
    padding:9px 10px;
    margin-top:10px;
    background:#1976d2;
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-size:15px;
    font-weight:600;
  }
  #loginBox button:active{
    transform:scale(0.98);
  }
  #loginError{
    color:#ff5252;
    margin-top:6px;
    font-size:13px;
    display:none;
  }
  #loginInfo{
    margin-top:8px;
    font-size:11px;
    opacity:0.7;
  }

  /* ==== LOGO HEADER ƒ∞√áƒ∞N ==== */
  .logo-small{
    width:38px;
    height:38px;
    border-radius:50%;
    object-fit:contain;
  }

  /* ==== SENƒ∞N MEVCUT TASARIMIN ==== */
  body{
    font-family:'Segoe UI',Arial,sans-serif;
    margin:0;
    padding:14px;
    --bg:#eef2f6;
    --text:#111;
    --card:rgba(255,255,255,0.6);
    --border:rgba(255,255,255,0.5);
  }
  body.dark{
    --bg:#0b0c0e;
    --text:#eee;
    --card:rgba(20,20,20,0.48);
    --border:rgba(255,255,255,0.06);
  }
  body{background:var(--bg);color:var(--text);}
  .header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    max-width:1200px;
    margin:0 auto 12px;
  }
  .title{display:flex;flex-direction:column;font-weight:700;}
  .subtitle{font-size:12px;opacity:0.75;margin-top:4px;}
  .right-controls{display:flex;align-items:center;gap:12px;}
  .clock{
    font-size:16px;
    font-weight:600;
    padding:8px 12px;
    border-radius:10px;
    background:var(--card);
    border:1px solid var(--border);
  }
  .lastData{font-size:12px;opacity:0.85;margin-top:6px;}
  .themeToggle{
    padding:6px 10px;
    border-radius:6px;
    border:1px solid var(--border);
    background:var(--card);
    cursor:pointer;
    font-size:14px;
  }
  #logoutBtn{
    padding:6px 10px;
    border-radius:6px;
    border:1px solid var(--border);
    background:var(--card);
    cursor:pointer;
    font-size:13px;
  }
  .summary{
    max-width:1200px;
    margin:8px auto;
    display:flex;
    gap:12px;
    justify-content:center;
    flex-wrap:wrap;
  }
  .sum-card{
    background:var(--card);
    border:1px solid var(--border);
    padding:12px 16px;
    border-radius:12px;
    min-width:120px;
    text-align:center;
  }
  .sum-label{font-size:12px;opacity:0.75;}
  .sum-val{font-size:18px;font-weight:700;margin-top:6px;}
  .grid{
    max-width:1200px;
    margin:14px auto;
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:16px;
    padding:0 6px;
  }
  @media(max-width:800px){.grid{grid-template-columns:1fr;}}
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
    transform-origin:top;
    transform:scale(0.9);
  }
  .card:hover{transform:scale(0.94);}
  .card-title{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    margin-bottom:8px;
    font-weight:700;
    font-size:15px;
  }
  .status-dot{
    width:12px;
    height:12px;
    border-radius:50%;
    display:inline-block;
    margin-left:8px;
  }
  .values-row{
    display:flex;
    justify-content:space-between;
    gap:10px;
    margin-bottom:8px;
  }
  .val-box{text-align:center;flex:1;}
  .val-num{
    font-weight:800;
    font-size:16px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
  }
  .val-label{font-size:12px;opacity:0.75;margin-top:4px;}
  .tiny{font-size:12px;opacity:0.7;}
  .flash-up{animation: flashGreen 420ms ease;}
  .flash-down{animation: flashRed 420ms ease;}
  @keyframes flashGreen{
    0%{color:#00e676;text-shadow:0 0 8px #00e676}
    100%{color:inherit;text-shadow:none}
  }
  @keyframes flashRed{
    0%{color:#ff3b30;text-shadow:0 0 8px #ff3b30}
    100%{color:inherit;text-shadow:none}
  }
  .status-text{font-size:13px;margin-top:6px;}
  .ic{width:16px;height:16px;display:inline-block;margin-right:6px;}
</style>
</head>
<body>

<!-- ========= LOGIN EKRANI ========= -->
<div id="loginScreen">
  <div id="loginBox">
    <img id="loginLogo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/29/D%C3%BCzce_University_logo.svg/1200px-D%C3%BCzce_University_logo.svg.png" alt="Logo">
    <h2>Akƒ±llƒ± DC G√º√ß √únitesi</h2>
    <p>Yetkili kullanƒ±cƒ± giri≈üi gereklidir.</p>
    <input type="text" id="user" placeholder="Kullanƒ±cƒ± adƒ±">
    <input type="password" id="pass" placeholder="≈ûifre">
    <button onclick="login()">Giri≈ü</button>
    <div id="loginError">Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±!</div>
    <div id="loginInfo">3 hatalƒ± denemede 30 saniye bloke olur.</div>
  </div>
</div>

<!-- ========= ASIL ƒ∞√áERƒ∞K (LOGIN SONRA A√áILIR) ========= -->
<div id="realContent" style="display:none;">

<div class="header">
  <div style="display:flex;align-items:center;gap:10px;">
    <img class="logo-small" src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/29/D%C3%BCzce_University_logo.svg/1200px-D%C3%BCzce_University_logo.svg.png" alt="Logo">
    <div class="title">
      <div>Akƒ±llƒ± DC G√º√ß √únitesi</div>
      <div class="subtitle" id="globalStatusText">Baƒülantƒ± kontrol ediliyor...</div>
    </div>
  </div>
  <div class="right-controls">
    <div class="clock" id="realtimeClock">--:--:--</div>
    <button class="themeToggle" id="themeToggle">üåô</button>
    <button id="logoutBtn" onclick="logout()">√áƒ±kƒ±≈ü</button>
    <div style="display:flex;flex-direction:column;align-items:center;">
      <div class="lastData tiny" id="lastDataTs">Son veri: ‚Äî</div>
    </div>
  </div>
</div>

<div class="summary">
  <div class="sum-card"><div class="sum-label">Toplam Voltaj</div><div class="sum-val" id="sumV">0.0 V</div></div>
  <div class="sum-card"><div class="sum-label">Toplam Akƒ±m</div><div class="sum-val" id="sumA">0.00 A</div></div>
  <div class="sum-card"><div class="sum-label">Toplam G√º√ß</div><div class="sum-val" id="sumW">0.0 W</div></div>
</div>

<div class="grid" id="grid"></div>

</div><!-- realContent biti≈ü -->

<script>
/* ========== LOGIN & G√úVENLƒ∞K KISMI ========== */

const USERNAME = "smartsocketproject";
const PASSWORD = "locationpassword81";

let attempts = Number(localStorage.getItem("loginAttempts")) || 0;
let blockUntil = Number(localStorage.getItem("blockUntil")) || 0;

const loginScreen = document.getElementById("loginScreen");
const realContent = document.getElementById("realContent");
const loginError = document.getElementById("loginError");

/* Sayfa a√ßƒ±lƒ±≈üƒ±nda daha √∂nce login var mƒ± kontrol et */
if(localStorage.getItem("loggedIn") === "true"){
  loginScreen.style.display = "none";
  realContent.style.display = "block";
} else {
  loginScreen.style.display = "flex";
  realContent.style.display = "none";
}

function login(){
  const now = Date.now();

  // Blok s√ºresi kontrol√º
  if(blockUntil > now){
    const waitSec = Math.ceil((blockUntil - now) / 1000);
    loginError.innerText = `√áok fazla deneme yapƒ±ldƒ±. ${waitSec} saniye bekleyin.`;
    loginError.style.display = "block";
    setTimeout(()=> loginError.style.display="none", 2000);
    return;
  }

  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value.trim();

  if(u === USERNAME && p === PASSWORD){
    localStorage.setItem("loggedIn","true");
    localStorage.removeItem("loginAttempts");
    localStorage.removeItem("blockUntil");
    loginScreen.style.display = "none";
    realContent.style.display = "block";
    return;
  }

  // Yanlƒ±≈ü giri≈ü
  attempts++;
  localStorage.setItem("loginAttempts", attempts);

  if(attempts >= 3){
    blockUntil = Date.now() + 30000; // 30 saniye
    localStorage.setItem("blockUntil", blockUntil);
    loginError.innerText = "3 kez hatalƒ± giri≈ü. 30 saniye bekleyin.";
  } else {
    loginError.innerText = "Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±!";
  }
  loginError.style.display = "block";
  setTimeout(()=> loginError.style.display="none", 2000);
}

function logout(){
  localStorage.removeItem("loggedIn");
  localStorage.removeItem("loginAttempts");
  localStorage.removeItem("blockUntil");
  location.reload();
}

/* ========== SENƒ∞N MEVCUT DASHBOARD KODUN ========== */

const MON_NAMES=["DC Soket √áƒ±kƒ±≈üƒ± 1","DC Soket √áƒ±kƒ±≈üƒ± 2","USB-A Portu 1","USB-A Portu 2"];
const OFFLINE_THRESHOLD=10000;
let grid=document.getElementById("grid");
let charts=[],lastReceived=[],lastGlobal=Date.now();

/* Clock */
setInterval(()=>{document.getElementById("realtimeClock").innerText=new Date().toLocaleTimeString();},1000);

/* Theme toggle */
document.getElementById("themeToggle").onclick=()=>{
  document.body.classList.toggle("dark");
  document.getElementById("themeToggle").innerText=document.body.classList.contains("dark")?"‚òÄÔ∏è":"üåô";
};

/* Build monitors */
for(let i=0;i<MON_NAMES.length;i++){
  const id="mon"+i;
  const html=`<div class="card" id="${id}">
    <div class="card-title">
      <strong>${MON_NAMES[i]}</strong>
      <div id="dot${i}" class="status-dot" style="background:#f44;"></div>
    </div>
    <div class="values-row">
      <div class="val-box"><div class="val-num"><span class="ic">üîã</span><span id="v${i}">--</span></div><div class="val-label">Volt (V)</div></div>
      <div class="val-box"><div class="val-num"><span class="ic">üß≤</span><span id="a${i}">--</span></div><div class="val-label">Akƒ±m (A)</div></div>
      <div class="val-box"><div class="val-num"><span class="ic">‚ö°</span><span id="w${i}">--</span></div><div class="val-label">G√º√ß (W)</div></div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div class="tiny">Sƒ±caklƒ±k: <span id="t${i}">--</span>¬∞C</div>
      <div class="tiny status-text" id="stat${i}">Durum: ‚Äî</div>
    </div>
    <canvas id="chart${i}" height="110"></canvas>
  </div>`;
  const div=document.createElement("div"); 
  div.innerHTML=html; 
  grid.appendChild(div.firstElementChild); 
  lastReceived[i]=0;
}

/* Charts setup */
for(let i=0;i<MON_NAMES.length;i++){
  const ctx=document.getElementById("chart"+i).getContext("2d");
  charts[i]=new Chart(ctx,{type:'line',data:{labels:[],datasets:[
    {label:'Volt (V)', data:[], borderColor:'#1E90FF', backgroundColor:'rgba(30,144,255,0.06)', tension:0.25, pointRadius:0},
    {label:'Akƒ±m (A)', data:[], borderColor:'#FF3B30', backgroundColor:'rgba(255,59,48,0.06)', tension:0.25, pointRadius:0},
    {label:'G√º√ß (W)', data:[], borderColor:'#00C853', backgroundColor:'rgba(0,200,83,0.06)', tension:0.25, pointRadius:0}
  ]}, options:{animation:false,plugins:{legend:{display:true}},scales:{x:{display:false}}}});
}

/* Helpers */
function fmtTs(ts){if(!ts) return "‚Äî"; const d=new Date(ts); return d.toLocaleDateString()+" "+d.toLocaleTimeString();}
function flash(el,type){el.classList.remove("flash-up","flash-down"); void el.offsetWidth; el.classList.add(type==="up"?"flash-up":"flash-down"); setTimeout(()=>{el.classList.remove("flash-up","flash-down");},400);}

/* WebSocket */
const protocol=(location.protocol==="https:")?"wss:":"ws:";
const WS_URL=protocol+"//"+location.host;
const socket=new WebSocket(WS_URL);

let lastTs=0;

socket.addEventListener("message",(e)=>{
  try{
    const msg=JSON.parse(e.data);
    if(msg.type==="init"||msg.type==="update"){
      lastTs=msg.ts||Date.now();
      document.getElementById("lastDataTs").innerText="Son veri: "+fmtTs(lastTs);
      processData(msg.data||{});
    } else if(msg.type==="offline"){ makeAllOffline(); }
  }catch(err){console.error(err);}
});

/* Process data */
function processData(obj){
  let totalV=0,totalA=0,totalW=0;
  let anyActive=false;

  for(let i=0;i<MON_NAMES.length;i++){
    const d=obj["monitor"+(i+1)]?.hat1 || null;
    const vEl=document.getElementById("v"+i),
          aEl=document.getElementById("a"+i),
          wEl=document.getElementById("w"+i),
          tEl=document.getElementById("t"+i);
    const statEl=document.getElementById("stat"+i),
          dotEl=document.getElementById("dot"+i);
    const ch=charts[i];

    if(!d){
      vEl.innerText=aEl.innerText=wEl.innerText=tEl.innerText="-";
      statEl.innerText="Baƒülantƒ± yok ‚Äî kontrol edilmeli"; 
      dotEl.style.background="#f33";
      continue;
    }

    const oldV=parseFloat(vEl.innerText)||0;
    const oldA=parseFloat(aEl.innerText)||0;
    const oldW=parseFloat(wEl.innerText)||0;

    const v=d.voltage?.value||0;
    const a=d.current?.value||0;
    const w=d.power?.value||0;

    vEl.innerText=v.toFixed(2);
    aEl.innerText=a.toFixed(3);
    wEl.innerText=w.toFixed(2);
    tEl.innerText=d.temperature?.value?.toFixed(1)||"-";

    flash(vEl, v>oldV?"up":"down");
    flash(aEl, a>oldA?"up":"down");
    flash(wEl, w>oldW?"up":"down");

    /* --- Enerji Yok E≈üik Kontrol√º --- */
    if(a < 0.005 || w < 0.05){
      statEl.innerText="Enerji yok‚ö†Ô∏è";
      dotEl.style.background="#ff9800";
    } else {
      statEl.innerText="Baƒülantƒ±: Aktif";
      dotEl.style.background="#0f0";
      anyActive=true;
    }

    /* Chart update */
    if(ch.data.labels.length>=30){
      ch.data.labels.shift();
      ch.data.datasets.forEach(ds=>ds.data.shift());
    }
    ch.data.labels.push("");
    ch.data.datasets[0].data.push(v);
    ch.data.datasets[1].data.push(a);
    ch.data.datasets[2].data.push(w);
    ch.update("none");

    totalV+=v; totalA+=a; totalW+=w;
    lastReceived[i]=Date.now();
  }

  document.getElementById("sumV").innerText=totalV.toFixed(2)+" V";
  document.getElementById("sumA").innerText=totalA.toFixed(3)+" A";
  document.getElementById("sumW").innerText=totalW.toFixed(2)+" W";

  const globalEl=document.getElementById("globalStatusText");

  if(anyActive) globalEl.innerText="Baƒülantƒ± ba≈üarƒ±lƒ±";
  else if(Date.now()-lastTs>OFFLINE_THRESHOLD) globalEl.innerText="Sistem ile ileti≈üim yok";
  else globalEl.innerText="Baƒülantƒ± kontrol ediliyor...";
}

function makeAllOffline(){
  MON_NAMES.forEach((m,i)=>{
    document.getElementById("v"+i).innerText="-";
    document.getElementById("a"+i).innerText="-";
    document.getElementById("w"+i).innerText="-";
    document.getElementById("t"+i).innerText="-";
    document.getElementById("stat"+i).innerText="Sistem ile ileti≈üim yok";
    document.getElementById("dot"+i).style.background="red";
  });
  document.getElementById("globalStatusText").innerText="Sistem ile ileti≈üim yok";
}

setInterval(()=>{
  if(Date.now()-lastTs>OFFLINE_THRESHOLD){
    makeAllOffline();
  }
},1000);
</script>
</body>
</html>
